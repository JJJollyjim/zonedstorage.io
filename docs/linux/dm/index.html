<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Zoned Storage Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Zoned Storage Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0DX1KGD5E4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0DX1KGD5E4",{})</script><title data-react-helmet="true">Device Mapper | Zoned Storage</title><meta data-react-helmet="true" property="og:url" content="https://zonedstorage.io/docs/linux/dm"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Device Mapper | Zoned Storage"><meta data-react-helmet="true" name="description" content="Zoned block device support was added to the device mapper subsystem in kernel"><meta data-react-helmet="true" property="og:description" content="Zoned block device support was added to the device mapper subsystem in kernel"><link data-react-helmet="true" rel="shortcut icon" href="/img/zs-logo.ico"><link data-react-helmet="true" rel="canonical" href="https://zonedstorage.io/docs/linux/dm"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/linux/dm" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/linux/dm" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.30532e53.css">
<link rel="preload" href="/assets/js/runtime~main.18692684.js" as="script">
<link rel="preload" href="/assets/js/main.e827f9a4.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Zoned Storage</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/docs/community/support">Community</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Zoned Storage</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/introduction">Documentation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/community/support">Community</a></li><li class="menu__list-item"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><div class="docSidebarContainer_0YBq" role="complementary"><div class="sidebar_a3j0"><div class="menu menu--responsive thin-scrollbar menu_cyFh"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_iZzd" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/zoned-storage">Zoned Storage Devices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/smr">Shingled Magnetic Recording</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/zns">NVMe Zoned Namespaces (ZNS) SSDs</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/prerequisites">System Prerequisites</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/nullblk">Zoned Block Device Emulation with nullblk</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/smr-disk">Getting Started with SMR Hard-Disks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/smr-emulation">Getting Started with Emulated SMR Hard-Disks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/zns-emulation">Getting Started with Emulated NVMe ZNS Devices</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Linux Kernel Support</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/overview">Linux Kernel Zoned Storage Support</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/config">Kernel Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/zbd-api">Zoned Block Device User Interface</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/sched">Write Ordering Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/part">Zoned Block Device Partition Support</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/linux/dm">Device Mapper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/fs">File Systems</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Applications</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications/percona-server">Percona Server for MySQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications/zenfs">RocksDB with ZenFS</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tools and Libraries</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/util-linux">Linux System Utilities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/zns">ZNS Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/sg3utils">SCSI Generic Utilities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/libzbc">libzbc User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/libzbd">libzbd User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/libnvme">libnvme User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/tcmu-runner">tcmu-runner ZBC Disk Emulation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tools/qemu">QEMU and KVM</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">System Compliance Tests</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests/zbc-tests">ZBC/ZAC Compliance Tests</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests/blktests">Kernel Block Layer Tests</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/distributions/linux">Linux Distributions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/benchmarking/benchmark">Benchmarking Zoned Block Devices</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq/faq">Frequently Asked Questions</a></li></ul></div></div></div><main class="docMainContainer_r8cw"><div class="container padding-vert--lg docItemWrapper_NJLN"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">Device Mapper</h1></header><div class="markdown"><p>Zoned block device support was added to the device mapper subsystem in kernel
version 4.13. Two existing targets gained support: the <em>dm-linear</em> target and
the <em>dm-flakey</em> target. ZBD support also added a new target driver, <em>dm-zoned</em>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="dm-linear"></a>dm-linear<a class="hash-link" href="#dm-linear" title="Direct link to heading">#</a></h2><p>The <em>dm-linear</em> target maps a linear range of blocks of the device-mapper device
onto a linear range on a backend device. <em>dm-linear</em> is the basic building
block of logical volume managers like</p><a href="http://www.sourceware.org/lvm2/" target="_blank" rel="noopener noreferrer">*LVM*</a>.<h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="zoned-block-device-restrictions"></a>Zoned Block Device Restrictions<a class="hash-link" href="#zoned-block-device-restrictions" title="Direct link to heading">#</a></h3><p>When used with zoned block devices, the <em>dm-linear</em> device that is created will
also be a zoned block device with the same zone size as the underlying device.
Several conditions are enforced by the device-mapper core-management code
during the creation of a <em>dm-linear</em> target device.</p><ul><li>All backend devices used to map different ranges of the target device must
have the same zone model.</li><li>If the backend devices are zoned block devices, all devices must have the same
zone size.</li><li>The mapped ranges must be zone aligned, that is, partial zone mapping is not
possible.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="example-creating-a-small-host-managed-disk"></a>Example: Creating a Small Host Managed Disk<a class="hash-link" href="#example-creating-a-small-host-managed-disk" title="Direct link to heading">#</a></h3><p>This example illustrates how to create a small host-managed disk that uses zone
ranges from a large high capacity host-managed disk. The zone information of
the backend device used is shown below.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/sdb/queue/zoned</span></div><div class="token-line" style="color:#393A34"><span class="token plain">host-managed</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/sdb/queue/chunk_sectors</span></div><div class="token-line" style="color:#393A34"><span class="token plain">524288</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># blkzone report /dev/sdb</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000080000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000100000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000180000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x010580000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x010600000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x010680000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x010700000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x6d2300000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x6d2380000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>To create a <em>dm-linear</em> device named &quot;small-sdb&quot; that joins the first 5
conventional zones of the backend device with the first 10 sequential zones,
use the following command.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># echo &quot;0 2621440 linear /dev/sdb 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">2621440 5242880 linear /dev/sdb 274726912&quot; | dmsetup create small-sdb</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The resulting device zone model is host-managed and has 15 zones, as shown
below.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/dm-0/queue/zoned</span></div><div class="token-line" style="color:#393A34"><span class="token plain">host-managed</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/dm-0/queue/chunk_sectors</span></div><div class="token-line" style="color:#393A34"><span class="token plain">524288</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># blkzone report /dev/dm-0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000080000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000100000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000180000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000200000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000280000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000300000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000380000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000400000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000480000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000500000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000580000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000600000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000680000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000700000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The following shows a script that facilitates the creation of <em>dm-linear</em>
devices using zone ranges from a single zoned block device. Such small zoned
block devices can be used to test application limits (e.g. Disk full
conditions).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><div tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$#</span><span class="token plain"> -ne </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Usage: </span><span class="token string variable" style="color:#36acaa">$0</span><span class="token string" style="color:#e3116c"> &lt;disk&gt; &lt;num conv zones&gt; &lt;num seq zones&gt;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">disk</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nrconv</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nrseq</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">dname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">basename</span><span class="token string variable" style="color:#36acaa"> $</span><span class="token string variable punctuation" style="color:#393A34">{</span><span class="token string variable" style="color:#36acaa">disk</span><span class="token string variable punctuation" style="color:#393A34">}</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Linear table entries: &quot;start length linear device offset&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># start: starting block in virtual device</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># length: length of this segment</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># device: block device, referenced by the device name or by major:minor</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># offset: starting offset of the mapping on the device</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">convlen</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa"> nrconv </span><span class="token variable operator" style="color:#393A34">*</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">524288</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">seqlen</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa"> nrseq </span><span class="token variable operator" style="color:#393A34">*</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">524288</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${convlen}</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${seqlen}</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0 zones...&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">seqofst</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">blkzone report </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$1</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;SEQ_WRITE_REQUIRED&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"></span></div><div class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">      </span><span class="token variable function" style="color:#d73a49">head</span><span class="token variable" style="color:#36acaa"> -n1 </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">cut</span><span class="token variable" style="color:#36acaa"> -f1 -d</span><span class="token variable string" style="color:#e3116c">&#x27;,&#x27;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">cut</span><span class="token variable" style="color:#36acaa"> -f2 -d</span><span class="token variable string" style="color:#e3116c">&#x27;:&#x27;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">xargs</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">printf</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;%d</span><span class="token variable string entity" style="color:#36acaa">\n</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${convlen}</span><span class="token plain"> -gt </span><span class="token variable" style="color:#36acaa">${seqofst}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">nrconv</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa"> seqofst </span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">524288</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Too many conventional zones requested: truncating to </span><span class="token string variable" style="color:#36acaa">$nrconv</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">convlen</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${seqofst}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${convlen}</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0 </span><span class="token string variable" style="color:#36acaa">${seqlen}</span><span class="token string" style="color:#e3116c"> linear </span><span class="token string variable" style="color:#36acaa">${disk}</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">${seqofst}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> dmsetup create small-</span><span class="token variable" style="color:#36acaa">${dname}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${seqlen}</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0 </span><span class="token string variable" style="color:#36acaa">${convlen}</span><span class="token string" style="color:#e3116c"> linear </span><span class="token string variable" style="color:#36acaa">${disk}</span><span class="token string" style="color:#e3116c"> 0&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> dmsetup create small-</span><span class="token variable" style="color:#36acaa">${dname}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0 </span><span class="token string variable" style="color:#36acaa">${convlen}</span><span class="token string" style="color:#e3116c"> linear </span><span class="token string variable" style="color:#36acaa">${disk}</span><span class="token string" style="color:#e3116c"> 0</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    </span><span class="token string variable" style="color:#36acaa">${convlen}</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">${seqlen}</span><span class="token string" style="color:#e3116c"> linear </span><span class="token string variable" style="color:#36acaa">${disk}</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">${seqofst}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> dmsetup create small-</span><span class="token variable" style="color:#36acaa">${dname}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="example-conventional-zones-as-a-regular-disk"></a>Example: Conventional Zones as a Regular Disk<a class="hash-link" href="#example-conventional-zones-as-a-regular-disk" title="Direct link to heading">#</a></h3><p><em>dm-linear</em> can also be used to aggregate a zoned block device&#x27;s conventional
zones together into a target device that will be usable as a regular disk
(conventional zones can be randomly written). Reusing the previous example
backend disk, 524 conventional zones of 524288 sectors (512 B unit) are
available. The following command creates a <em>dm-linear</em> device joining all
conventional zones together.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># echo &quot;0 274726912 linear /dev/sdb 0&quot; | dmsetup create small-sdb</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The target device is again a host-managed disk but contains only conventional
zones.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/dm-0/queue/zoned</span></div><div class="token-line" style="color:#393A34"><span class="token plain">host-managed</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/dm-0/queue/chunk_sectors</span></div><div class="token-line" style="color:#393A34"><span class="token plain">524288</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># blkzone report /dev/dm-0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000080000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000100000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000180000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x010500000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  start: 0x010580000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Because this zoned block device is composed entirely of conventional zones, all
sectors are randomly writable and can therefore be used directly with any file
system.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># mkfs.ext4 /dev/dm-0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mke2fs 1.44.6 (5-Mar-2019)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Creating filesystem with 34340864 4k blocks and 8585216 inodes</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Filesystem UUID: 3957429a-5dab-4b30-9797-f9736036a47b</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Superblock backups stored on blocks:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    4096000, 7962624, 11239424, 20480000, 23887872</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Allocating group tables: done</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing inode tables: done</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Creating journal (262144 blocks): done</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing superblocks and filesystem accounting information: done</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># mount /dev/dm-0 /mnt</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># ls -l /mnt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">total 16</span></div><div class="token-line" style="color:#393A34"><span class="token plain">drwx------ 2 root root 16384 May 21 17:03 lost+found</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Applications that need frequent random updates to their metadata can use such
setups to facilitate the implementation of a complex metadata structure. The
remaining sequential zones of the disk can be used directly by the application
to store data.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="dm-flakey"></a>dm-flakey<a class="hash-link" href="#dm-flakey" title="Direct link to heading">#</a></h2><p>The <em>dm-flakey</em> target is similar to the <em>dm-linear</em> target, except that it
periodically exhibits unreliable behavior. This target is useful for simulating
failing devices during testing. In the case of zoned block devices,
simulating write errors to sequential zones can help to debug application
write-pointer management.</p><p><em>dm-flakey</em> works like this: at the time the table is loaded, the device does
not generate errors for some seconds (<em>up</em> time), but then exhibits unreliable
behavior for <em>down</em> seconds. This cycle then repeats.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="error-modes"></a>Error modes<a class="hash-link" href="#error-modes" title="Direct link to heading">#</a></h3><p>Several error-simulation behaviors can be configured.</p><ul><li><strong>drop_writes</strong> All write I/Os are silently ignored and dropped. Read I/Os
are handled correctly.</li><li><strong>error_writes</strong> All write I/Os are failed with an error signaled. Read I/Os
are handled correctly.</li><li><strong>corrupt_bio_byte</strong> During the <em>down</em> time, replace the Nth byte of the
data of each read or write block I/O with a specified value.</li></ul><p>The default error mode is to fail all I/O requests during the <em>down</em> time of the
simulation cycle.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="zoned-block-device-restrictions-1"></a>Zoned Block Device Restrictions<a class="hash-link" href="#zoned-block-device-restrictions-1" title="Direct link to heading">#</a></h3><p>The same restrictions apply that applied for the <em>dm-linear</em> target.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="examples"></a>Examples<a class="hash-link" href="#examples" title="Direct link to heading">#</a></h3><p><em>dm-linear</em> detailed documentation and usage examples can be found in the kernel
source code documentation file <a href="https://github.com/torvalds/linux/blob/master/Documentation/device-mapper/dm-flakey.txt" target="_blank" rel="noopener noreferrer">Documentation/device-mapper/dm-flakey.txt</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="dm-zoned"></a>dm-zoned<a class="hash-link" href="#dm-zoned" title="Direct link to heading">#</a></h2><p>The <em>dm-zoned</em> device mapper target provides random write access to zoned
block devices (ZBC and ZAC compliant devices). It hides the sequential write constraint of host-managed zoned block devices from the device user (the &quot;device user&quot;, in this context, is a file system or an application accessing a raw block device). This allows the use of applications and file systems that do not have native zoned block device support.</p><p>File systems or applications that can natively support host-managed zoned
block devices (e.g. the f2fs file system since kernel 4.10) do not need to use
the <em>dm-zoned</em> device mapper target.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-overview"></a>Design Overview<a class="hash-link" href="#design-overview" title="Direct link to heading">#</a></h3><p><em>dm-zoned</em> implements an on-disk write buffering scheme to handle random
write accesses to sequential write required zones of a zoned block device.
Conventional zones of the backend device are used for buffering random
accesses, as well as for storing internal metadata.</p><p>The figure below illustrates the <em>dm-zoned</em> zone-usage principle.</p><div class="container text--center"><figure><img src="/assets/images/linux-dm-zoned-7f01ae74923ff02b8d01c92fef2d376d.png" width="640" max-width="100%"><figcaption><em>Zone mapping overview of the dm-zoned device mapper target</em></figcaption></figure></div><p>Optionally, since Linux kernel version 5.8.0, an additional regular block
device can be used to provide randomly writable storage, replacing<br>
the conventional zones of the backend zoned block device for write buffering.
With this new version of <em>dm-zoned</em>, multiple zoned block devices can also be
used to increase performance.</p><p>All zones of the device(s) used to back a <em>dm-zoned</em> target are separated into
2 types:</p><ol><li><p><strong>Metadata zones</strong> These are randomly-writable zones that are used to store
metadata.  Randomly writable zones may be conventional zones or sequential
write preferred zones (host-aware devices only). Metadata zones are not
reported as usable capacity to the user. If an additional regular block
device is used for write buffering, metadata zones are stored on this
cache device.</p></li><li><p><strong>Data zones</strong> All remaining zones of the device. The majority of these zones
are sequential zones, which are used exclusively for storing user data.
The conventional zones (or part of the sequential-write-preferred zones
on a host-aware device) may be used also for buffering user random writes.
User data may thus be stored either in conventional zone or in a sequential
zone.</p></li></ol><p>As shown in the above figure, the target device is divided into chunks that
have the same size as the zones of the backing zoned devices. A logical chunk
can be mapped to zones of the backing device in different ways.</p><ol><li><strong>Conventional or cache zone mapping</strong> This is the case for chunk <em>A</em> in the
figure, which is mapped to the conventional zone <em>C<sub>A</sub></em>. This is the
default mapping that is initialized when the first write command is issued
to an empty (unwritten) chunk. As long as a chunk is mapped to a
conventional zone, any incoming write request can be directly executed
using the mapped conventional zone.</li><li><strong>Sequential zone mapping</strong> A chunk can be mapped initially to a
sequential zone, as shown for the chunk <em>C</em> (mapped to the sequential zone
<em>S<sub>C</sub></em> in the figure). With such a mapping, an already-written
block of the chunk cannot be modified directly. To handle this case, the
next mapping type is used.</li><li><strong>Dual conventional-sequential zone mapping</strong> Temporarily add a conventional
zone to the chunk mapping when you need to update data in an already-written
block of a chunk that has been mapped to a sequential zone. Any write
that targets a written block will be processed using the conventional
zone instead of the sequential zone.</li></ol><p><em>dm-zoned</em> metadata include a set of bitmaps to track the validity state of
blocks in the zones of the backing device. Any write-operation execution is
always followed by an update to the bitmaps, to mark the written blocks as
valid. In the case of the dual conventional-sequential chunk mapping, the
bitmap for the blocks of the sequential zone is updated to clear the bits
that represent the blocks that have been updated with a write in the
conventional zone. By doing this, incoming reads always have access to the
latest version of the block data simply by inspecting the block validity
bitmaps.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="on-disk-format"></a>On-Disk Format<a class="hash-link" href="#on-disk-format" title="Direct link to heading">#</a></h3><p><em>dm-zoned</em> exposes a logical device with a sector size of 4096 bytes,
irrespectively of the physical sector size of the backend zoned block device
being used. This allows reducing the amount of metadata needed to manage valid
blocks (blocks written). The on-disk metadata format is as follows:</p><ol><li><p>The first block of the first randomly writable zone found contains the
super block which describes the amount and position on disk of metadata blocks. </p></li><li><p>Following the super block, a set of blocks is used to describe the mapping
of the logical chunks of the target logical device to data zones. The mapping
is indexed by logical chunk number and each mapping entry indicates the data
zone storing the chunk data and optionally the zone number of a random zone
used to buffer random modification to the chunk data.</p></li><li><p>A set of blocks used to store bitmaps indicating the validity of blocks in
the data zones follows the mapping table blocks. A valid block is a block that
was writen and not discarded. For a buffered data zone, a block can be valid
only in the data zone or in the buffer zone.</p></li></ol><p>To protect internal metadata against corruption in case of sudden power loss or
system crash, two sets of metadata zones are used. One set, the primary set, is
used as the main metadata set, while the secondary set is used as a log.
Modified metadata are first written to the secondary set and the log so created
validated by writing an updated super block in the secondary set. Once this log
operation completes, updates in place of metadata blocks can be done in the
primary metadata set, ensuring that one of the set is always correct.
Flush operations are used as a commit point: upon reception of a flush
operation, metadata activity is temporarily stopped, all dirty metadata logged
and updated and normal operation resumed. This only temporarily delays write and
discard requests. Read requests can be processed while metadata logging is
executed.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="read-write-processing"></a>Read-Write Processing<a class="hash-link" href="#read-write-processing" title="Direct link to heading">#</a></h3><p>For a logical chunk mapped to a random data zone, all write operations are
processed by directly writing to the data zone. If the mapping zone is to a
sequential zone, the write operation is processed directly only and only if
the write offset within the logical chunk is equal to the write pointer offset
within of the sequential data zone (i.e. the write operation is aligned on the
zone write pointer). Otherwise, write operations are processed indirectly using
a buffer zone: a randomly writable free data zone is allocated and assigned
to the chunk being accessed in addition to the already mapped sequential data
zone. Writing block to the buffer zone will invalidate the same blocks in the
sequential data zone.</p><p>Read operations are processed according to the block validity information
provided by the bitmaps: valid blocks are read either from the data zone or,
if the data zone is buffered, from the buffer zone assigned to the data zone.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="random-zone-reclaim"></a>Random Zone Reclaim<a class="hash-link" href="#random-zone-reclaim" title="Direct link to heading">#</a></h3><p>After some time, the limited number of random zones available may be exhausted
and unaligned writes to unbuffered zones become impossible. To avoid such
situation, a reclaim process regularly scans used random zones and try to
&quot;reclaim&quot; them by copying (sequentially) the valid blocks of the buffer zone
to a free sequential zone. Once the copy completes, the chunk mapping is
updated to point to the sequential zone and the buffer zone freed for reuse.</p><p>To protect internal metadata against corruption in case of sudden power loss or
system crash, 2 sets of metadata zones are used. One set, the primary set, is
used as the main metadata repository, while the secondary set is used as a log.
Modified metadata are first written to the secondary set and the log so created
validated by writing an updated super block in the secondary set. Once this log
operation completes, updates in place of metadata blocks can be done in the
primary metadata set, ensuring that one of the set is always correct.
Flush operations are used as a commit point: upon reception of a flush
operation, metadata activity is temporarily stopped, all dirty metadata logged
and updated and normal operation resumed. This only temporarily delays write
and discard requests. Read requests can be processed while metadata logging is
executed.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="userspace-tool"></a>Userspace Tool<a class="hash-link" href="#userspace-tool" title="Direct link to heading">#</a></h3><p>The <em>dmzadm</em> command line utility is used to format backend zoned devices for
use with the <em>dm-zoned</em> device mapper target. This utility will verify the
device zone model and will prepare and write on-disk <em>dm-zoned</em> metadata
according to the device capacity, zone size, etc.</p><p>The source code for the <em>dmzadm</em> utility is available as part of
the <a href="https://github.com/westerndigitalcorporation/dm-zoned-tools" target="_blank" rel="noopener noreferrer"><em>dm-zoned-tools</em> project hosted on GitHub</a>.
The project <a href="https://github.com/westerndigitalcorporation/dm-zoned-tools/blob/master/README.md" target="_blank" rel="noopener noreferrer"><em>README</em> file</a> provides instructions on how to compile and
install the utility.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The <em>dm-zoned-tools</em> project was formerly hosted on GitHub as part of
the <a href="https://github.com/hgst" target="_blank" rel="noopener noreferrer">HGST organization</a>.
<em>dm-zoned-tools</em> repository has since then moved to
the <a href="https://github.com/westerndigitalcorporation/" target="_blank" rel="noopener noreferrer">Western Digital Corporation organization on GitHub</a>.</p></div></div><p><em>dmzadm</em> detailed usage is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmzadm --help</span></div><div class="token-line" style="color:#393A34"><span class="token plain">dmzadm allows formatting, checking and repairing</span></div><div class="token-line" style="color:#393A34"><span class="token plain">a zoned block device for use with the dm-zoned</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device mapper.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Usage: dmzadm &lt;operation&gt; &lt;device(s)&gt; [options]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Operations</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --help | -h   : General help message</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --format      : Format a block device metadata</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --check       : Check a block device metadata</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --repair      : Repair a block device metadata</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --start       : Start the device-mapper target</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --stop        : Stop the device-mapper target</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Devices</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  For a single device target, a zoned block device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  must be specified. For a multi-device target, a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  a list of block devices must be specified, with</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  a regular block device as the first device specified,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  followed by one or more zoned block devices</span></div><div class="token-line" style="color:#393A34"><span class="token plain">General options</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --verbose     : Verbose output</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --vverbose    : Very verbose output</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Format operation options</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --force       : Force overwrite of existing content</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --label=&lt;str&gt; : Set the target label name to &lt;str&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  --seq=&lt;num&gt;   : Number of sequential zones reserved</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                  for reclaim. The minimum is 1 and the</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                  default is 16</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="formatting-a-target-device"></a>Formatting a Target Device<a class="hash-link" href="#formatting-a-target-device" title="Direct link to heading">#</a></h3><p>Formatting a single device target is done using the command.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmzadm --format /dev/&lt;disk name&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>where <code>/dev/&lt;disk name&gt;</code> identifies the backend zoned block device to use. An
example execution using a SMR hard-disk is shown below.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmzadm --format /dev/sdi</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/dev/sdi: 29297213440 512-byte sectors (13970 GiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Host-managed device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  55880 zones, offset 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  55880 zones of 524288 512-byte sectors (256 MiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  65536 4KB data blocks per zone</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Resetting sequential zones</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing primary metadata set</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing mapping table</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing bitmap blocks</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing super block to sdi block 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing secondary metadata set</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing mapping table</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing bitmap blocks</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing super block to sdi block 131072</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Syncing disk</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Done.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Starting with Linux kernel v5.8.0, regular block devices such as SSDs can also
be used together with zoned block devices with <em>dm-zoned</em>. In this case,
conventional zones are emulated for the regular block device to hold <em>dm-zoned</em>
metadata and for buffering data. When a regular block device is used, the zone
reclaim process operates by copying data from emulated conventional zones on
the regular block device to zones of the zoned block device. This dual-drive
configuration can significantly increase performance of the target device
under write-intensive workloads.</p><p>To format a <em>dm-zoned</em> target device using an additional regular block device
and optionally several zoned block devices, the following commands can be used.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmzadm --format /dev/nvme2n1 /dev/sdi</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/dev/nvme2n1: 976773168 512-byte sectors (465 GiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Regular block device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  1864 zones, offset 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/dev/sdi: 29297213440 512-byte sectors (13970 GiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Host-managed device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  55880 zones, offset 122159104</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  57743 zones of 524288 512-byte sectors (256 MiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  1 runt zone of 24624 512-byte sectors (12 MiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  65536 4KB data blocks per zone</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Resetting sequential zones</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing primary metadata set</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing mapping table</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing bitmap blocks</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing super block to nvme2n1 block 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing secondary metadata set</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing mapping table</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing bitmap blocks</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing super block to nvme2n1 block 131072</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing tertiary metadata</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Writing super block to sdi block 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Syncing disk</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Syncing disk</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Done.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Where <code>/dev/nvme2n1</code> is in this example a NVMe SSD and <code>/dev/sdi</code> is a
host managed SMR hard-disk.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="activating-a-target-device"></a>Activating a Target Device<a class="hash-link" href="#activating-a-target-device" title="Direct link to heading">#</a></h3><p>The <em>dm-zoned</em> target device using a formatted zoned device or set of devices
can be started by executing <em>dmzadm</em> with the <code>--start</code> command.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmzadm --start /dev/sdi</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/dev/sdi: 29297213440 512-byte sectors (13970 GiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Host-managed device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  55880 zones, offset 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  55880 zones of 524288 512-byte sectors (256 MiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  65536 4KB data blocks per zone</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sdi: starting dmz-sdi uuid 8c505b4b-d1e9-47a7-8e3a-8b1c00317eaf</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The target start can be confirmed by looking at the kernel messages.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmesg</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (dmz-sdi): DM-Zoned metadata version 2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (sdi): Host-managed zoned block device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (sdi):   29297213440 512-byte logical sectors (offset 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (sdi):   55880 zones of 524288 512-byte logical sectors (offset 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (dmz-sdi):   55880 zones of 524288 512-byte logical sectors</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned: (dmz-sdi): Target device: 29286727680 512-byte logical sectors (3660840960 blocks)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The target device created is a regular disk that can be used with any file
system.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/dm-0/queue/zoned</span></div><div class="token-line" style="color:#393A34"><span class="token plain">none</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># mkfs.ext4 /dev/dm-0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mke2fs 1.45.5 (07-Jan-2020)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Discarding device blocks: done                            </span></div><div class="token-line" style="color:#393A34"><span class="token plain">Creating filesystem with 3660840960 4k blocks and 457605120 inodes</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Filesystem UUID: d49ed278-5bca-46c4-8ce2-cec263dd060c</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Superblock backups stored on blocks: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968, </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    102400000, 214990848, 512000000, 550731776, 644972544, 1934917632, </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    2560000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Allocating group tables: done                            </span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing inode tables: done                            </span></div><div class="token-line" style="color:#393A34"><span class="token plain">Creating journal (262144 blocks): done</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Writing superblocks and filesystem accounting information: done</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># mount /dev/dm-0 /mnt</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># ls -l /mnt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">total 16</span></div><div class="token-line" style="color:#393A34"><span class="token plain">drwx------ 2 root root 16384 Aug 27 15:14 lost+found</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>For a multi-device target, the same list of devices as used for format must be
specified.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmzadm --start /dev/nvmen2p1 /dev/sdi</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/dev/nvme2n1: 976773168 512-byte sectors (465 GiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Regular block device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  1864 zones, offset 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/dev/sdi: 29297213440 512-byte sectors (13970 GiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Host-managed device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  55880 zones, offset 122159104</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  57743 zones of 524288 512-byte sectors (256 MiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  1 runt zone of 24624 512-byte sectors (12 MiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  65536 4KB data blocks per zone</span></div><div class="token-line" style="color:#393A34"><span class="token plain">nvme2n1: starting dmz-nvme2n1 uuid ffbd1a3a-d79b-4d7f-bc13-e475a157bc39</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Similarly to the single device case, kernel messages notify the target device
activation.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (dmz-nvme2n1): DM-Zoned metadata version 2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (nvme2n1): Regular block device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (nvme2n1):   976773168 512-byte logical sectors (offset 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (nvme2n1):   1864 zones of 524288 512-byte logical sectors (offset 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (sdi): Host-managed zoned block device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (sdi):   29297213440 512-byte logical sectors (offset 977272832)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (sdi):   55880 zones of 524288 512-byte logical sectors (offset 1864)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned metadata: (dmz-nvme2n1):   57744 zones of 524288 512-byte logical sectors</span></div><div class="token-line" style="color:#393A34"><span class="token plain">device-mapper: zoned: (dmz-nvme2n1): Target device: 30264000512 512-byte logical sectors (3783000064 blocks)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="stopping-a-target-device"></a>Stopping a Target Device<a class="hash-link" href="#stopping-a-target-device" title="Direct link to heading">#</a></h3><p>A <em>dm-zoned</em> target device can be disabled using the <code>--stop</code> operation.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmzadm --stop /dev/sdX</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>For a multi-device target, the same list of devices as used for format must be
specified.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/linux/part"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Zoned Block Device Partition Support</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/linux/fs"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">File Systems Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#dm-linear" class="table-of-contents__link">dm-linear</a><ul><li><a href="#zoned-block-device-restrictions" class="table-of-contents__link">Zoned Block Device Restrictions</a></li><li><a href="#example-creating-a-small-host-managed-disk" class="table-of-contents__link">Example: Creating a Small Host Managed Disk</a></li><li><a href="#example-conventional-zones-as-a-regular-disk" class="table-of-contents__link">Example: Conventional Zones as a Regular Disk</a></li></ul></li><li><a href="#dm-flakey" class="table-of-contents__link">dm-flakey</a><ul><li><a href="#error-modes" class="table-of-contents__link">Error modes</a></li><li><a href="#zoned-block-device-restrictions-1" class="table-of-contents__link">Zoned Block Device Restrictions</a></li><li><a href="#examples" class="table-of-contents__link">Examples</a></li></ul></li><li><a href="#dm-zoned" class="table-of-contents__link">dm-zoned</a><ul><li><a href="#design-overview" class="table-of-contents__link">Design Overview</a></li><li><a href="#on-disk-format" class="table-of-contents__link">On-Disk Format</a></li><li><a href="#read-write-processing" class="table-of-contents__link">Read-Write Processing</a></li><li><a href="#random-zone-reclaim" class="table-of-contents__link">Random Zone Reclaim</a></li><li><a href="#userspace-tool" class="table-of-contents__link">Userspace Tool</a></li><li><a href="#formatting-a-target-device" class="table-of-contents__link">Formatting a Target Device</a></li><li><a href="#activating-a-target-device" class="table-of-contents__link">Activating a Target Device</a></li><li><a href="#stopping-a-target-device" class="table-of-contents__link">Stopping a Target Device</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/zoned-storage">Introduction to Zoned Storage</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting Started with Zoned Storage</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://app.element.io/#/room/#zonedstorage-general:matrix.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix</a></li><li class="footer__item"><a href="https://join.slack.com/t/zonedstorage/shared_invite/zt-uyfut5xe-nKajp9YRnEWqiD4X6RkTFw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://webchat.oftc.net/?channels=zonedstorage" target="_blank" rel="noopener noreferrer" class="footer__link-item">IRC @ OFTC</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/westerndigitalcorporation" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Organization</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Western Digital
	Corporation or its affiliates. All rights reserved.<br> By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use" target="_blank">Terms of Use</a> and <a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank">Privacy Statement</a>.  All example scripts and program snippets on this site are licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CCO 1.0 Universal</a> license.<br>This site is built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.18692684.js"></script>
<script src="/assets/js/main.e827f9a4.js"></script>
</body>
</html>