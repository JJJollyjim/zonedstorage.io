<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Zoned Storage Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Zoned Storage Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0DX1KGD5E4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0DX1KGD5E4",{})</script><title data-react-helmet="true">tcmu-runner ZBC Disk Emulation | Zoned Storage</title><meta data-react-helmet="true" property="og:url" content="https://zonedstorage.io/docs/tools/tcmu-runner"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="tcmu-runner ZBC Disk Emulation | Zoned Storage"><meta data-react-helmet="true" name="description" content="tcmu-runner is an application daemon that can handle the execution of SCSI"><meta data-react-helmet="true" property="og:description" content="tcmu-runner is an application daemon that can handle the execution of SCSI"><link data-react-helmet="true" rel="shortcut icon" href="/img/zs-logo.ico"><link data-react-helmet="true" rel="canonical" href="https://zonedstorage.io/docs/tools/tcmu-runner"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/tools/tcmu-runner" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/tools/tcmu-runner" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c9b2f887.css">
<link rel="preload" href="/assets/js/runtime~main.989ef241.js" as="script">
<link rel="preload" href="/assets/js/main.9f0435fb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Zoned Storage</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/docs/community/support">Community</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Zoned Storage</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/introduction">Documentation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/community/support">Community</a></li><li class="menu__list-item"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><div class="docSidebarContainer_0YBq" role="complementary"><div class="sidebar_a3j0"><div class="menu menu--responsive thin-scrollbar menu_cyFh"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_iZzd" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/zoned-storage">Zoned Storage Devices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/smr">Shingled Magnetic Recording</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/zns">NVMe Zoned Namespaces (ZNS) SSDs</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/prerequisites">System Prerequisites</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/nullblk">Zoned Block Device Emulation with nullblk</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/smr-disk">Getting Started with SMR Hard-Disks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/smr-emulation">Getting Started with Emulated SMR Hard-Disks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/zns-emulation">Getting Started with Emulated NVMe ZNS Devices</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Linux Kernel Support</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/overview">Linux Kernel Zoned Storage Support</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/config">Kernel Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/zbd-api">Zoned Block Device User Interface</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/sched">Write Ordering Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/part">Zoned Block Device Partition Support</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/dm">Device Mapper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/fs">File Systems</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Applications</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications">Applications</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications/zenfs">RocksDB with ZenFS</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Tools and Libraries</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/util-linux">Linux System Utilities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/zns">ZNS Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/sg3utils">SCSI Generic Utilities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libzbc">libzbc User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libzbd">libzbd User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libnvme">libnvme User Library</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/tools/tcmu-runner">tcmu-runner ZBC Disk Emulation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/qemu">QEMU and KVM</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">System Compliance Tests</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests/zbc-tests">ZBC/ZAC Compliance Tests</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests/blktests">Kernel Block Layer Tests</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/distributions/linux">Linux Distributions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/benchmarking/benchmark">Benchmarking Zoned Block Device</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq/faq">Frequently Asked Questions</a></li></ul></div></div></div><main class="docMainContainer_r8cw"><div class="container padding-vert--lg docItemWrapper_NJLN"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">tcmu-runner ZBC Disk Emulation</h1></header><div class="markdown"><p><em>tcmu-runner</em> is an application daemon that can handle the execution of SCSI
commands sent by the kernel SCSI target sub component, allowing exporting SCSI
Logical Units (LUNs) to be backed by regular files or block devices.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>LinuxIO (LIOâ„¢) is the standard open-source SCSI target implementation in the
LinuxÂ® kernel. LIO supports all prevalent storage fabrics, including Fibre
Channel, FCoE, iEEE 1394, iSCSI, NVMe-OF, iSER, SRP, etc.</p><p>The Target Core Module Userspace (TCMU) implements a fabric that creates a link
between the kernel SCSI target infrastructure and a user space application.
The kernel level module involved is <code>target_core_user</code> and can be viewed as a
virtual HBA.</p><p><em>tcmu-runner</em> implements the userspace level side of the ank processing,
handling the details of the TCMU interface (UIO, netlink, pthreads, and DBus).
<em>tcmu-runner</em> exports a more simple C plugin API allowing the creation of
<em>file handlers</em> to emulate various device types. This organization is shown
in the figure below.</p><div class="container text--center"><figure><img src="/assets/images/tools-tcmu-dc8b8095c58f25df749406030dcc1b25.png" width="640" max-width="100%"><figcaption><em>tcmu-runner overview</em></figcaption></figure></div><p>The <em>ZBC file handler</em> implements a SCSI ZBC host aware or host managed disk
emulation using TCMU C plugin API. This handler uses a regular file as the
backend storage for the emulated device.</p><p>With this infrastructure setup, any command issued by an application or by a
kernel component (e.g. a file system) will be sent to the <em>tcmu-runner</em> daemon
through the TCMU kernel driver. The file handler can process the command in user
space using regular POSIX system calls and a reply sent back on completion of
the command processing. From the point of view of the application or kernel
component using the emulated disk, all accesses appear as executing on actual
hardware.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="compilation-and-installation"></a>Compilation and Installation<a class="hash-link" href="#compilation-and-installation" title="Direct link to heading">#</a></h2><p>The <em>tcmu-runner</em> project is hosted on <a href="https://github.com/open-iscsi/tcmu-runner" target="_blank" rel="noopener noreferrer">GitHub</a>.  The project <a href="https://github.com/open-iscsi/tcmu-runner/blob/master/README.md" target="_blank" rel="noopener noreferrer"><em>README</em></a> file provides detailed information on how to
compile, install and execute <em>tcmu-runner</em> daemon.</p><p>The control of <em>tcmu-runner</em> emulated devices is achieved using the <em>targetcli</em>
utility available as a package with most distributions. For instance, on
<a href="/docs/distributions/linux#fedora-linux">FedoraÂ®</a> Linux, <em>tcmu-runner</em> and
<em>targetcli</em> can be installed using the following commands.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dnf install tcmu-runner</span></div><div class="token-line" style="color:#393A34"><span class="token plain"># dnf install targetcli</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="kernel-components"></a>Kernel Components<a class="hash-link" href="#kernel-components" title="Direct link to heading">#</a></h2><p><em>tcmu-runner</em> relies on the loopback virtual SAS adapter kernel module to expose
the emulated device as a regular disk to the kernel SCSI stack. Enabling this
kernel module first requires that support for the <em>Generic Target Core Mod (TCM)
and ConfigFS Infrastructure</em> be enabled from the top-level <em>Device Drivers</em>
menu.</p><div class="container text--center"><figure><img src="/assets/images/linux-config-tcm1-7684c969474b143f4f71318501623f6f.png" width="640" max-width="100%"><figcaption><em>Target Core Module support option with make menuconfig</em></figcaption></figure></div><p>With  this infrastructure enabled, the configuration option <em>CONFIG_TCM_USER2</em>
and <em>CONFIG_LOOPBACK_TARGET</em> can be enabled.</p><div class="container text--center"><figure><img src="/assets/images/linux-config-tcm2-6bbd5067f606b5e32db5520dea899278.png" width="640" max-width="100%"><figcaption><em>TCM user and loopback adapter support option with make menuconfig</em></figcaption></figure></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="zbc-file-handler"></a>ZBC File Handler<a class="hash-link" href="#zbc-file-handler" title="Direct link to heading">#</a></h2><p><em>tcmu-runner</em> ZBC file handler is compiled and installed by default. This
handler allows the creation of emulated ZBC disks with a regular file used as
backing storage.</p><p>The ZBC file handler supports the emulation of both host aware and host managed
SCSI disks. Furthermore, the characteristics of the emulated device can all be
configured. The following table shows the configuration parameters available.</p><table><thead><tr><th>Option</th><th>Description</th><th>Default value</th></tr></thead><tbody><tr><td>model-<strong><em>type</em></strong></td><td>Device model type, <em>HA</em> for host aware or <em>HM</em> for host managed</td><td><em>HM</em></td></tr><tr><td>lba-<strong><em>size (B)</em></strong></td><td>LBA size in bytes (512 or 4096)</td><td>512</td></tr><tr><td>zsize-<strong><em>size (MiB)</em></strong></td><td>Zone size in MiB</td><td>256 MiB</td></tr><tr><td>conv-<strong><em>num</em></strong></td><td>Number of conventional zones at LBA 0 (can be 0)</td><td>Number of zones corresponding to 1% of the device capacity</td></tr><tr><td>open-<strong><em>num</em></strong></td><td>Optimal (for host aware) or maximum (for host managed) number of open zones</td><td>128</td></tr></tbody></table><p>These parameters are always grouped together into a configuration string with
the format <code>/[opt1[/opt2][...]@]path_to_backing_file</code>. For instance, to specify
a host managed disk with 128MB zone size, 100 conventional zones and the file
<code>/var/local/zbc0.raw</code> as backing storage, the following configuration string can
be used.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cfgstring=model-HM/zsize-128/conv-100@/var/local/zbc.raw</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="creating-an-emulated-disk"></a>Creating an Emulated disk<a class="hash-link" href="#creating-an-emulated-disk" title="Direct link to heading">#</a></h2><p>The following example shows how to create a small 20 GB host managed ZBC disk
with 10 conventional zones and a 256 MiB zone size, with the file
<code>/var/local/zbc0.raw</code> used as backing storage. The emulated disk will be locally
emulated using the loopback interface. This require that <em>tcmu-runner</em> be
executed on the system.</p><p>With <em>tcmu-runner</em> running, the <em>targetcli</em> command is used to create the
emulated disk.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># targetcli</span></div><div class="token-line" style="color:#393A34"><span class="token plain">targetcli shell version 2.1.fb49</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Copyright 2011-2013 by Datera, Inc and others.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">For help on commands, type &#x27;help&#x27;.</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; cd /backstores/user:zbc</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; {==create name=zbc0 size=20G cfgstring=model-HM/zsize-256/conv-10@/var/local/zbc0.raw==}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created user-backed storage object zbc0 size 21474836480.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; cd /loopback</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/loopback&gt; create</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created target naa.500140529100d742.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/loopback&gt; cd naa.500140529100d742/luns</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/loopback/naa...9100d742/luns&gt; create /backstores/user:zbc/zbc0 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created LUN 0.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/loopback/naa...9100d742/luns&gt; cd /</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; ls</span></div><div class="token-line" style="color:#393A34"><span class="token plain">o- / ..................................................................... [...]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- backstores .......................................................... [...]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- block .............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- fileio ............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- pscsi .............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- ramdisk ............................................ [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:fbo ........................................... [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:poma .......................................... [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:zbc ........................................... [Storage Objects: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |   o- zbc0  [model-HM/zsize-256/conv-10@/var/local/zbc0.raw (20.0GiB) activated]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |     o- alua ............................................... [ALUA Groups: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |       o- default_tg_pt_gp ................... [ALUA state: Active/optimized]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- iscsi ........................................................ [Targets: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- loopback ..................................................... [Targets: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- naa.500140529100d742 ............................. [naa.50014059e05d5424]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |   o- luns ........................................................ [LUNs: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |     o- lun0 ................................. [user/zbc0 (default_tg_pt_gp)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- vhost ........................................................ [Targets: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; exit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The backstore create command specifies the emulated disk capacity with the
argument <code>size=20G</code>. The backing file <code>/var/local/zbc0.raw</code> will be created if
necessary and resized to match the requested capacity.</p><p>When the backstore is linked to <code>lun0</code> of the loopback link, the emulated device
becomes visible by the kernel and its management initialized in the same manner
as with physical devices. This can be seen in the kernel messages log.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># dmesg</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">scsi host11: TCM_Loopback</span></div><div class="token-line" style="color:#393A34"><span class="token plain">scsi 11:0:1:0: Direct-Access-ZBC LIO-ORG  TCMU ZBC device  0002 PQ: 0 ANSI: 5</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: Attached scsi generic sg4 type 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] Host-managed zoned block device</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] 41943040 512-byte logical blocks: (21.5 GB/20.0 GiB)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] 80 zones of 524288 logical blocks</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] Write Protect is off</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] Mode Sense: 0f 00 00 00</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] Write cache: enabled, read cache: enabled, doesn&#x27;t support DPO or FUA</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] Optimal transfer size 65536 bytes</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sde] Attached SCSI disk</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The disk can now be listed with tools such as <em>lsblk</em> and <em>lsscsi</em>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[2:0:0:0]    disk    ATA      INTEL SSDSC2CT18 335u  /dev/sda   /dev/sg0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[4:0:0:0]    zbc     ATA      HGST HSH721414AL T220  /dev/sdb   /dev/sg1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[10:0:1:0]   zbc     ATA      HGST HSH721414AL W209  /dev/sdc   /dev/sg2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[10:0:2:0]   zbc     HGST     HSH721414AL52M0  a220  /dev/sdd   /dev/sg3</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[11:0:1:0]   zbc     LIO-ORG  TCMU ZBC device  0002  /dev/sde   /dev/sg4</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="using-an-emulated-disk"></a>Using an Emulated disk<a class="hash-link" href="#using-an-emulated-disk" title="Direct link to heading">#</a></h2><p>All ZBD compliant tools and applications will be able to access and control the
emulated disk in exactly the same manner as a physical device. For instance,
<a href="/docs/tools/libzbc#graphical-interface"><em>libzbc</em> graphical interface (gzbc)</a> can be used
to display the emulated disk zones.</p><div class="container text--center"><figure><img src="/assets/images/tools-tcmu-gzbc-11fb58818ee21d5116da8329d0d479af.png" width="640" max-width="100%"><figcaption><em>tcmu-runner ZBC emulated disk view in gzbc</em></figcaption></figure></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="scripts"></a>Scripts<a class="hash-link" href="#scripts" title="Direct link to heading">#</a></h2><p>The following script is useful to create an emulated disk with a single command.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><div tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$#</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Usage: </span><span class="token string variable" style="color:#36acaa">$0</span><span class="token string" style="color:#e3116c"> &lt;disk name&gt; &lt;cap (GB)&gt; HM|HA &lt;zone size (MB)&gt; &lt;conv zones num&gt;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">dname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">model</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$3</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">zs</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$4</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">cnum</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$5</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">naa</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;naa.50014059cfa9ba75&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Setup emulated disk</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> targetcli</span><span class="token string" style="color:#e3116c"></span></div><div class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c">
</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd /backstores/user:zbc</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">create name=</span><span class="token string variable" style="color:#36acaa">${dname}</span><span class="token string" style="color:#e3116c"> size=</span><span class="token string variable" style="color:#36acaa">${cap}</span><span class="token string" style="color:#e3116c">G cfgstring=model-</span><span class="token string variable" style="color:#36acaa">${model}</span><span class="token string" style="color:#e3116c">/zsize-</span><span class="token string variable" style="color:#36acaa">${zs}</span><span class="token string" style="color:#e3116c">/conv-</span><span class="token string variable" style="color:#36acaa">${cnum}</span><span class="token string" style="color:#e3116c">@/var/local/</span><span class="token string variable" style="color:#36acaa">${dname}</span><span class="token string" style="color:#e3116c">.raw</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd /loopback</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">create </span><span class="token string variable" style="color:#36acaa">${naa}</span><span class="token string" style="color:#e3116c"></span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd </span><span class="token string variable" style="color:#36acaa">${naa}</span><span class="token string" style="color:#e3116c">/luns</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">create /backstores/user:zbc/</span><span class="token string variable" style="color:#36acaa">${dname}</span><span class="token string" style="color:#e3116c"> 0</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd /</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">exit</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c">
</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">disk</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">lsscsi </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;TCMU ZBC device&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">cut</span><span class="token variable" style="color:#36acaa"> -d </span><span class="token variable string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token variable" style="color:#36acaa"> -f3 </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">sed</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;s/ //g&#x27;</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mq-deadline&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /sys/block/</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${disk}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">/queue/scheduler</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tearing down an emulated disk can also be automated with a single command line
as shown below.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><div tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$#</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Usage: </span><span class="token string variable" style="color:#36acaa">$0</span><span class="token string" style="color:#e3116c"> &lt;disk name (e.g. zbc0)&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">dname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">naa</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;naa.50014059cfa9ba75&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Delete emulated disk</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> targetcli</span><span class="token string" style="color:#e3116c"></span></div><div class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c">
</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd /loopback/</span><span class="token string variable" style="color:#36acaa">${naa}</span><span class="token string" style="color:#e3116c">/luns</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">delete 0</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd /loopback</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">delete </span><span class="token string variable" style="color:#36acaa">${naa}</span><span class="token string" style="color:#e3116c"></span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd /backstores/user:zbc</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">delete </span><span class="token string variable" style="color:#36acaa">${dname}</span><span class="token string" style="color:#e3116c"></span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">cd /</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">exit</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c">
</span></div><div class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/tools/libnvme"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« libnvme User Library</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/tools/qemu"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">QEMU and KVM Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#compilation-and-installation" class="table-of-contents__link">Compilation and Installation</a></li><li><a href="#kernel-components" class="table-of-contents__link">Kernel Components</a></li><li><a href="#zbc-file-handler" class="table-of-contents__link">ZBC File Handler</a></li><li><a href="#creating-an-emulated-disk" class="table-of-contents__link">Creating an Emulated disk</a></li><li><a href="#using-an-emulated-disk" class="table-of-contents__link">Using an Emulated disk</a></li><li><a href="#scripts" class="table-of-contents__link">Scripts</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/zoned-storage">Introduction to Zoned Storage</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/index">Getting Started with Zoned Storage</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://app.element.io/#/room/#zonedstorage-general:matrix.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix</a></li><li class="footer__item"><a href="https://join.slack.com/t/zonedstorage/shared_invite/zt-uyfut5xe-nKajp9YRnEWqiD4X6RkTFw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://webchat.oftc.net/?channels=zonedstorage" target="_blank" rel="noopener noreferrer" class="footer__link-item">IRC @ OFTC</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/westerndigitalcorporation" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Organization</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Western Digital
	Corporation or its affiliates. All rights reserved.<br> By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use" target="_blank">Terms of Use</a> and <a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank">Privacy Statement</a>.  All example scripts and program snippets on this site are licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CCO 1.0 Universal</a> license.<br>This site is built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.989ef241.js"></script>
<script src="/assets/js/main.9f0435fb.js"></script>
</body>
</html>