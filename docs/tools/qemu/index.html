<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0DX1KGD5E4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0DX1KGD5E4",{})</script><title data-react-helmet="true">QEMU and KVM | Zoned Storage</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zonedstorage.io/docs/tools/qemu"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="QEMU and KVM | Zoned Storage"><meta data-react-helmet="true" name="description" content="QEMU is a generic machine"><meta data-react-helmet="true" property="og:description" content="QEMU is a generic machine"><link data-react-helmet="true" rel="icon" href="/img/zs-logo.ico"><link data-react-helmet="true" rel="canonical" href="https://zonedstorage.io/docs/tools/qemu"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/tools/qemu" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/tools/qemu" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.1a239bed.css">
<link rel="preload" href="/assets/js/runtime~main.abe8ee4b.js" as="script">
<link rel="preload" href="/assets/js/main.c8920a35.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Zoned Storage</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/docs/community/support">Community</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/introduction">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/getting-started">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/linux">Linux Kernel Support</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/applications">Applications</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/tools">Tools and Libraries</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/util-linux">Linux System Utilities</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/zns">ZNS Tools</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/sg3utils">SCSI Generic Utilities</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libzbc">libzbc User Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libzbd">libzbd User Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libnvme">libnvme User Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/tcmu-runner">tcmu-runner ZBC Disk Emulation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tools/qemu">QEMU and KVM</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/tests">System Compliance Tests</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/distributions/linux">Linux Distributions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/benchmarking/benchmark">Benchmarking Zoned Block Devices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq/">Frequently Asked Questions</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>QEMU and KVM</h1><p><em><a href="https://www.qemu.org/" target="_blank" rel="noopener noreferrer">QEMU</a></em> is a generic machine
emulator and virtualizer. <em>QEMU</em> also provides the userspace components
of the widely used <a href="https://www.linux-kvm.org/" target="_blank" rel="noopener noreferrer"><em>KVM</em>
(Kernel-based Virtual Machine)</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="qemu-and-zoned-block-devices">QEMU and zoned block devices<a class="hash-link" href="#qemu-and-zoned-block-devices" title="Direct link to heading">â€‹</a></h2><p>Host managed SMR disks can be directly attached to a <em>QEMU</em> guest for running
applications in a virtual machine environment. This is especially useful in the
case of software and kernel development and tests.</p><p>There are two supported methods to attach Host managed SMR zoned disks to a QEMU
guest: <em>virtio-scsi</em> and <em>vhost-scsi</em>.</p><p>Furthermore, <em>QEMU</em> also allows emulating NVMe devices implementing zoned
namespaces.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="qemu-virtio-scsi"><em>QEMU virtio-scsi</em><a class="hash-link" href="#qemu-virtio-scsi" title="Direct link to heading">â€‹</a></h2><p>This is the simplest method to attach a zoned block device for access from a
QEMU guest. To do so, the QEMU option <em>virtio-scsi-pci</em> is used after defining a
virtual PCI bus and SCSI host.</p><p>For instance, the following command will run QEMU with </p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device virtio-scsi-pci,bus=pcie.0,id=scsi0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -drive file={==/dev/sdf==},format=raw,if=none,id=zbc0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device scsi-block,bus=scsi0.0,drive=zbc0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The first line <code>-device pcie-root-port,bus=pcie.0,id=rp1</code> creates a PCIe root
complex. The second line <code>-device virtio-scsi-pci,bus=pcie.0,id=scsi0</code> defines
a virtio adapter connected to the PCIe bus previously defined. Finally, the last
2 lines <code>-drive file=/dev/sdf,format=raw,if=none,id=zbc0</code> and
<code>-device scsi-block,bus=scsi0.0,drive=zbc0</code> define the device connected to the
virtio SCSI adapter. In this example, since <code>-device scsi-block</code> is used, the
host device to attach is specified using the device block device file
(<code>/dev/sdf</code>) in this example.</p><p>See <a href="https://github.com/qemu/qemu/blob/master/docs/pcie_pci_bridge.txt" target="_blank" rel="noopener noreferrer">here</a> for a detailed description of these options.</p><p>Though this method allows attaching a zoned block disk to a QEMU guest, SCSI
command sense data is not processed correctly in QEMU versions prior to version
4.1. This causes the guest operating system to hang if the guest attempts to
access a command sense data (for instance upon command failures). This
attachment method should thus be avoided with versions of QEMU older than
version 4.1.</p><p>To avoid the sense data problem with QEMU versions preceding version 4.1, a
zoned disk can be attached to a guest using the device SG node file as a
specifier. In this case, the option <code>-device scsi-generic</code> must be used. The
command line is changed as follows.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device virtio-scsi-pci,bus=pcie.0,id=scsi0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -drive file={==/dev/sg5==},format=raw,if=none,id=zbc0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device scsi-generic,bus=scsi0.0,drive=zbc0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>On the host, the correspondance between a block device file and its SG node file
can be discovered using the <code>lsscsi</code> command.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[10:0:1:0]   zbc     HGST     HSH721415AL42M0  a250  {==/dev/sdf==}   {==/dev/sg5==}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Once the guest operating system is started, attachment of the host device can be
checked with any of the methods shown <a href="/docs/getting-started/smr-disk">here</a>.
For instance, the output of the <code>lsscsi</code> command will be as follows with the
above example setup.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0:0:0:0]    disk    ATA      QEMU HARDDISK    2.5+  /dev/sda   /dev/sg0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[6:0:1:0]    zbc     HGST     HSH721415AL42M0  a250  /dev/sdb   /dev/sg1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="qemu-vhost-scsi"><em>QEMU vhost-scsi</em><a class="hash-link" href="#qemu-vhost-scsi" title="Direct link to heading">â€‹</a></h2><p>This attachment method uses a fabric module in the host kernel to provide KVM
guests with a fast virtio-based connection to SCSI LUNs. This method cannot be
used without QEMU KVM acceleration.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="enabling-the-host-vhost-target-module">Enabling the host vhost target module<a class="hash-link" href="#enabling-the-host-vhost-target-module" title="Direct link to heading">â€‹</a></h3><p>The host kernel configuration must have the <em>CONFIG_VHOST_SCSI</em> option enabled.
This option is found in the top level <em>Virtualization</em> menu of the kernel
configuration.</p><div class="container text--center"><figure><img src="/assets/images/linux-config-vhost-21cc5561b882aa8097fb30aa35664908.png" width="640" max-width="100%"><figcaption><em>vhost-scsi support option with make menuconfig</em></figcaption></figure></div><p>To allow attaching physical disks as well as
<a href="/docs/tools/tcmu-runner"><em>tcmu-runner</em></a> emulated ZBC disks, the kernel
configuration option <em>COFNGI_TCM_PSCSI</em> should also be enbaled. This option can
be found in the menu <em>Device Drivers</em> -&gt; <em>Generic Target Core Mod (TCM) and
ConfigFS Infrastructure</em>.</p><div class="container text--center"><figure><img src="/assets/images/linux-config-pscsi-e7c9db15cc4aebcf65fb21db3521a144.png" width="640" max-width="100%"><figcaption><em>pSCSI TCM support option with make menuconfig</em></figcaption></figure></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="attaching-a-host-physical-disk">Attaching a host physical disk<a class="hash-link" href="#attaching-a-host-physical-disk" title="Direct link to heading">â€‹</a></h3><p>To attach to a virtual machine guest a zoned device, a virtual TCM SAS adapter
must first be prepared using the <em>targetcli</em> tool. The device to attach must be
specified using a block device file. The example below illustrates this
operation for the disk <code>/dev/sdf</code>.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># targetcli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">targetcli shell version 2.1.fb49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright 2011-2013 by Datera, Inc and others.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For help on commands, type &#x27;help&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; cd backstores/pscsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/backstores/pscsi&gt; create name=disk1 dev=/dev/sdf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note: block backstore recommended for SCSI block devices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created pscsi storage object disk1 using /dev/sdf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/backstores/pscsi&gt; cd /vhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created target {==naa.5001405a160fe2e1==}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created TPG 1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/vhost/naa.5001405a160fe2e1&gt; cd /vhost/naa.5001405a160fe2e1/tpg1/luns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/vhost/naa.50...2e1/tpg1/luns&gt; create /backstores/pscsi/disk1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created LUN 0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/vhost/naa.50...2e1/tpg1/luns&gt; cd /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">o- / ..................................................................... [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- backstores .......................................................... [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- block .............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- fileio ............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- pscsi .............................................. [Storage Objects: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | | o- disk1 ............................................ [/dev/sdf activated]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | |   o- alua ............................................... [ALUA Groups: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- ramdisk ............................................ [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:fbo ........................................... [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:rbd ........................................... [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:zbc ........................................... [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- iscsi ........................................................ [Targets: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- loopback ..................................................... [Targets: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- vhost ........................................................ [Targets: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o- {==naa.5001405a160fe2e1==} .......................................... [TPGs: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      o- tpg1 .............................. [naa.500140565cd16730, no-gen-acls]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o- acls ...................................................... [ACLs: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o- luns ...................................................... [LUNs: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          o- lun0 .............................. [pscsi/disk1 (/dev/sdf) (None)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; exit</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The World-Wide port name assigned by <em>targetcli</em> can then be used to specify the
device to attach on QEMU command line.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device vhost-scsi-pci,wwpn={==naa.5001405a160fe2e1==},bus=pcie.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The attached disk can then be seen from the guest OS using (for instance) the
<em>lsscsi</em> command.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0:0:0:0]    disk    ATA      QEMU HARDDISK    2.5+  /dev/sda   /dev/sg0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[6:0:1:0]    zbc     HGST     HSH721415AL42M0  a250  /dev/sdb   /dev/sg1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="attaching-an-emulated-zbc-disk">Attaching an emulated ZBC disk<a class="hash-link" href="#attaching-an-emulated-zbc-disk" title="Direct link to heading">â€‹</a></h3><p><em>tcmu-runner</em> can be used to create emulated ZBC host managed SCSI disks. The
emulated disk created can be used either locally on the host using the loopback
fabric adapter, as explained <a href="/docs/tools/tcmu-runner#creating-an-emulated-disk">here</a>.</p><p>Similarly to a physical device (previous section), the emulated ZBC disk can
also be attached to a vhost virtual adapter for use within a KVM guest operating
system. The following example illustrates this procedure, creating a small 20GB
host managed SCSI disk with 256 MB zones including 10 conventional zones.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># targetcli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">targetcli shell version 2.1.fb49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright 2011-2013 by Datera, Inc and others.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For help on commands, type &#x27;help&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; cd /backstores/user:zbc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; create name=zbc0 size=20G cfgstring=model-HM/zsize-256/conv-10@/var/local/zbc0.raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created user-backed storage object zbc0 size 21474836480.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; cd /vhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created target {==naa.5001405a0776dce3==}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created TPG 1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; /vhost/naa.5001405a0776dce3/tpg1/luns create /backstores/user:zbc/zbc0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created LUN 0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; cd /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">o- / ..................................................................... [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- backstores .......................................................... [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- block .............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- fileio ............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- pscsi .............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- ramdisk ............................................ [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:fbo ........................................... [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:rbd ........................................... [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:zbc ........................................... [Storage Objects: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |   o- zbc0  [model-HM/zsize-256/conv-10@/var/local/zbc0.raw (20.0GiB) activated]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     o- alua ............................................... [ALUA Groups: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |       o- default_tg_pt_gp ................... [ALUA state: Active/optimized]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- iscsi ........................................................ [Targets: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- loopback ..................................................... [Targets: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- vhost ........................................................ [Targets: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o- {==naa.5001405a0776dce3==} .......................................... [TPGs: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      o- tpg1 .............................. [naa.500140533e375d94, no-gen-acls]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o- acls ...................................................... [ACLs: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o- luns ...................................................... [LUNs: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          o- lun0 ............................... [user/zbc0 (default_tg_pt_gp)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; exit</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The virtual machine can then be started with the emulated ZBC disk attached
using the World-Wide port name assigned by <em>targetcli</em>.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -device vhost-scsi-pci,wwpn={==naa.5001405a0776dce3==},bus=pcie.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The disk is listed on the guest with tools such as <em>lsscsi</em>.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx plaintext"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0:0:0:0]    disk    ATA      QEMU HARDDISK    2.5+  /dev/sda   /dev/sg0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[6:0:1:0]    zbc     LIO-ORG  TCMU ZBC device  0002  /dev/sdb   /dev/sg1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="qemu-nvme-zns-device-emulation"><em>QEMU</em> NVMe ZNS Device emulation<a class="hash-link" href="#qemu-nvme-zns-device-emulation" title="Direct link to heading">â€‹</a></h2><p><a href="/docs/getting-started/zns-emulation">This article</a> describes in details, with
examples, how <em>QEMU</em> can be configured to create an emulated NVMe ZNS namespace
visible by the guest operating system.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/tools/tcmu-runner"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">tcmu-runner ZBC Disk Emulation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/tests"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Overview</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#qemu-and-zoned-block-devices" class="table-of-contents__link toc-highlight">QEMU and zoned block devices</a></li><li><a href="#qemu-virtio-scsi" class="table-of-contents__link toc-highlight"><em>QEMU virtio-scsi</em></a></li><li><a href="#qemu-vhost-scsi" class="table-of-contents__link toc-highlight"><em>QEMU vhost-scsi</em></a><ul><li><a href="#enabling-the-host-vhost-target-module" class="table-of-contents__link toc-highlight">Enabling the host vhost target module</a></li><li><a href="#attaching-a-host-physical-disk" class="table-of-contents__link toc-highlight">Attaching a host physical disk</a></li><li><a href="#attaching-an-emulated-zbc-disk" class="table-of-contents__link toc-highlight">Attaching an emulated ZBC disk</a></li></ul></li><li><a href="#qemu-nvme-zns-device-emulation" class="table-of-contents__link toc-highlight"><em>QEMU</em> NVMe ZNS Device emulation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/zoned-storage">Introduction to Zoned Storage</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting Started with Zoned Storage</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://app.element.io/#/room/#zonedstorage-general:matrix.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Matrix<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://join.slack.com/t/zonedstorage/shared_invite/zt-uyfut5xe-nKajp9YRnEWqiD4X6RkTFw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://webchat.oftc.net/?channels=zonedstorage" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>IRC @ OFTC<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/westerndigitalcorporation" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub Organization<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Western Digital
	Corporation or its affiliates. All rights reserved.<br> By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use" target="_blank">Terms of Use</a> and <a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank">Privacy Statement</a>.  All example scripts and program snippets on this site are licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CCO 1.0 Universal</a> license.<br>This site is built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.abe8ee4b.js"></script>
<script src="/assets/js/main.c8920a35.js"></script>
</body>
</html>