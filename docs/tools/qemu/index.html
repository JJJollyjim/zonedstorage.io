<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Zoned Storage Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Zoned Storage Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0DX1KGD5E4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0DX1KGD5E4",{})</script><title data-react-helmet="true">QEMU and KVM | Zoned Storage</title><meta data-react-helmet="true" property="og:url" content="https://zonedstorage.io/docs/tools/qemu"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="QEMU and KVM | Zoned Storage"><meta data-react-helmet="true" name="description" content="QEMU is a generic machine"><meta data-react-helmet="true" property="og:description" content="QEMU is a generic machine"><link data-react-helmet="true" rel="shortcut icon" href="/img/zs-logo.ico"><link data-react-helmet="true" rel="canonical" href="https://zonedstorage.io/docs/tools/qemu"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/tools/qemu" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zonedstorage.io/docs/tools/qemu" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.30532e53.css">
<link rel="preload" href="/assets/js/runtime~main.97f7f774.js" as="script">
<link rel="preload" href="/assets/js/main.e827f9a4.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Zoned Storage</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/docs/community/support">Community</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Zoned Storage</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/introduction">Documentation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/community/support">Community</a></li><li class="menu__list-item"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><div class="docSidebarContainer_0YBq" role="complementary"><div class="sidebar_a3j0"><div class="menu menu--responsive thin-scrollbar menu_cyFh"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_iZzd" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/zoned-storage">Zoned Storage Devices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/smr">Shingled Magnetic Recording</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction/zns">NVMe Zoned Namespaces (ZNS) SSDs</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/prerequisites">System Prerequisites</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/nullblk">Zoned Block Device Emulation with nullblk</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/smr-disk">Getting Started with SMR Hard-Disks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/smr-emulation">Getting Started with Emulated SMR Hard-Disks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/zns-emulation">Getting Started with Emulated NVMe ZNS Devices</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Linux Kernel Support</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/overview">Linux Kernel Zoned Storage Support</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/config">Kernel Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/zbd-api">Zoned Block Device User Interface</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/sched">Write Ordering Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/part">Zoned Block Device Partition Support</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/dm">Device Mapper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/linux/fs">File Systems</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Applications</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications/percona-server">Percona Server for MySQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/applications/zenfs">RocksDB with ZenFS</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Tools and Libraries</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/util-linux">Linux System Utilities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/zns">ZNS Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/sg3utils">SCSI Generic Utilities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libzbc">libzbc User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libzbd">libzbd User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/libnvme">libnvme User Library</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools/tcmu-runner">tcmu-runner ZBC Disk Emulation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/tools/qemu">QEMU and KVM</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">System Compliance Tests</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests/zbc-tests">ZBC/ZAC Compliance Tests</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tests/blktests">Kernel Block Layer Tests</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/distributions/linux">Linux Distributions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/benchmarking/benchmark">Benchmarking Zoned Block Devices</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq/faq">Frequently Asked Questions</a></li></ul></div></div></div><main class="docMainContainer_r8cw"><div class="container padding-vert--lg docItemWrapper_NJLN"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">QEMU and KVM</h1></header><div class="markdown"><p><em><a href="https://www.qemu.org/" target="_blank" rel="noopener noreferrer">QEMU</a></em> is a generic machine
emulator and virtualizer. <em>QEMU</em> also provides the userspace components
of the widely used <a href="https://www.linux-kvm.org/" target="_blank" rel="noopener noreferrer"><em>KVM</em>
(Kernel-based Virtual Machine)</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="qemu-and-zoned-block-devices"></a>QEMU and zoned block devices<a class="hash-link" href="#qemu-and-zoned-block-devices" title="Direct link to heading">#</a></h2><p>Host managed SMR disks can be directly attached to a <em>QEMU</em> guest for running
applications in a virtual machine environment. This is especially useful in the
case of software and kernel development and tests.</p><p>There are two supported methods to attach Host managed SMR zoned disks to a QEMU
guest: <em>virtio-scsi</em> and <em>vhost-scsi</em>.</p><p>Furthermore, <em>QEMU</em> also allows emulating NVMe devices implementing zoned
namespaces.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="qemu-virtio-scsi"></a><em>QEMU virtio-scsi</em><a class="hash-link" href="#qemu-virtio-scsi" title="Direct link to heading">#</a></h2><p>This is the simplest method to attach a zoned block device for access from a
QEMU guest. To do so, the QEMU option <em>virtio-scsi-pci</em> is used after defining a
virtual PCI bus and SCSI host.</p><p>For instance, the following command will run QEMU with </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device virtio-scsi-pci,bus=pcie.0,id=scsi0 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -drive file={==/dev/sdf==},format=raw,if=none,id=zbc0 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device scsi-block,bus=scsi0.0,drive=zbc0</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The first line <code>-device pcie-root-port,bus=pcie.0,id=rp1</code> creates a PCIe root
complex. The second line <code>-device virtio-scsi-pci,bus=pcie.0,id=scsi0</code> defines
a virtio adapter connected to the PCIe bus previously defined. Finally, the last
2 lines <code>-drive file=/dev/sdf,format=raw,if=none,id=zbc0</code> and
<code>-device scsi-block,bus=scsi0.0,drive=zbc0</code> define the device connected to the
virtio SCSI adapter. In this example, since <code>-device scsi-block</code> is used, the
host device to attach is specified using the device block device file
(<code>/dev/sdf</code>) in this example.</p><p>See <a href="https://github.com/qemu/qemu/blob/master/docs/pcie_pci_bridge.txt" target="_blank" rel="noopener noreferrer">here</a> for a detailed description of these options.</p><p>Though this method allows attaching a zoned block disk to a QEMU guest, SCSI
command sense data is not processed correctly in QEMU versions prior to version
4.1. This causes the guest operating system to hang if the guest attempts to
access a command sense data (for instance upon command failures). This
attachment method should thus be avoided with versions of QEMU older than
version 4.1.</p><p>To avoid the sense data problem with QEMU versions preceding version 4.1, a
zoned disk can be attached to a guest using the device SG node file as a
specifier. In this case, the option <code>-device scsi-generic</code> must be used. The
command line is changed as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device virtio-scsi-pci,bus=pcie.0,id=scsi0 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -drive file={==/dev/sg5==},format=raw,if=none,id=zbc0 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device scsi-generic,bus=scsi0.0,drive=zbc0</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>On the host, the correspondance between a block device file and its SG node file
can be discovered using the <code>lsscsi</code> command.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[10:0:1:0]   zbc     HGST     HSH721415AL42M0  a250  {==/dev/sdf==}   {==/dev/sg5==}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Once the guest operating system is started, attachment of the host device can be
checked with any of the methods shown <a href="/docs/getting-started/smr-disk">here</a>.
For instance, the output of the <code>lsscsi</code> command will be as follows with the
above example setup.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[0:0:0:0]    disk    ATA      QEMU HARDDISK    2.5+  /dev/sda   /dev/sg0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[6:0:1:0]    zbc     HGST     HSH721415AL42M0  a250  /dev/sdb   /dev/sg1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="qemu-vhost-scsi"></a><em>QEMU vhost-scsi</em><a class="hash-link" href="#qemu-vhost-scsi" title="Direct link to heading">#</a></h2><p>This attachment method uses a fabric module in the host kernel to provide KVM
guests with a fast virtio-based connection to SCSI LUNs. This method cannot be
used without QEMU KVM acceleration.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="enabling-the-host-vhost-target-module"></a>Enabling the host vhost target module<a class="hash-link" href="#enabling-the-host-vhost-target-module" title="Direct link to heading">#</a></h3><p>The host kernel configuration must have the <em>CONFIG_VHOST_SCSI</em> option enabled.
This option is found in the top level <em>Virtualization</em> menu of the kernel
configuration.</p><div class="container text--center"><figure><img src="/assets/images/linux-config-vhost-21cc5561b882aa8097fb30aa35664908.png" width="640" max-width="100%"><figcaption><em>vhost-scsi support option with make menuconfig</em></figcaption></figure></div><p>To allow attaching physical disks as well as
<a href="/docs/tools/tcmu-runner"><em>tcmu-runner</em></a> emulated ZBC disks, the kernel
configuration option <em>COFNGI_TCM_PSCSI</em> should also be enbaled. This option can
be found in the menu <em>Device Drivers</em> -&gt; <em>Generic Target Core Mod (TCM) and
ConfigFS Infrastructure</em>.</p><div class="container text--center"><figure><img src="/assets/images/linux-config-pscsi-e7c9db15cc4aebcf65fb21db3521a144.png" width="640" max-width="100%"><figcaption><em>pSCSI TCM support option with make menuconfig</em></figcaption></figure></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="attaching-a-host-physical-disk"></a>Attaching a host physical disk<a class="hash-link" href="#attaching-a-host-physical-disk" title="Direct link to heading">#</a></h3><p>To attach to a virtual machine guest a zoned device, a virtual TCM SAS adapter
must first be prepared using the <em>targetcli</em> tool. The device to attach must be
specified using a block device file. The example below illustrates this
operation for the disk <code>/dev/sdf</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># targetcli</span></div><div class="token-line" style="color:#393A34"><span class="token plain">targetcli shell version 2.1.fb49</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Copyright 2011-2013 by Datera, Inc and others.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">For help on commands, type &#x27;help&#x27;.</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; cd backstores/pscsi</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/backstores/pscsi&gt; create name=disk1 dev=/dev/sdf</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Note: block backstore recommended for SCSI block devices</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created pscsi storage object disk1 using /dev/sdf</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/backstores/pscsi&gt; cd /vhost</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; create</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created target {==naa.5001405a160fe2e1==}.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created TPG 1.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/vhost/naa.5001405a160fe2e1&gt; cd /vhost/naa.5001405a160fe2e1/tpg1/luns</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/vhost/naa.50...2e1/tpg1/luns&gt; create /backstores/pscsi/disk1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created LUN 0.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/vhost/naa.50...2e1/tpg1/luns&gt; cd /</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; ls</span></div><div class="token-line" style="color:#393A34"><span class="token plain">o- / ..................................................................... [...]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- backstores .......................................................... [...]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- block .............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- fileio ............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- pscsi .............................................. [Storage Objects: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | | o- disk1 ............................................ [/dev/sdf activated]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | |   o- alua ............................................... [ALUA Groups: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- ramdisk ............................................ [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:fbo ........................................... [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:rbd ........................................... [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:zbc ........................................... [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- iscsi ........................................................ [Targets: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- loopback ..................................................... [Targets: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- vhost ........................................................ [Targets: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    o- {==naa.5001405a160fe2e1==} .......................................... [TPGs: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      o- tpg1 .............................. [naa.500140565cd16730, no-gen-acls]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        o- acls ...................................................... [ACLs: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        o- luns ...................................................... [LUNs: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          o- lun0 .............................. [pscsi/disk1 (/dev/sdf) (None)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; exit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The World-Wide port name assigned by <em>targetcli</em> can then be used to specify the
device to attach on QEMU command line.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device vhost-scsi-pci,wwpn={==naa.5001405a160fe2e1==},bus=pcie.0</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The attached disk can then be seen from the guest OS using (for instance) the
<em>lsscsi</em> command.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[0:0:0:0]    disk    ATA      QEMU HARDDISK    2.5+  /dev/sda   /dev/sg0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[6:0:1:0]    zbc     HGST     HSH721415AL42M0  a250  /dev/sdb   /dev/sg1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="attaching-an-emulated-zbc-disk"></a>Attaching an emulated ZBC disk<a class="hash-link" href="#attaching-an-emulated-zbc-disk" title="Direct link to heading">#</a></h3><p><em>tcmu-runner</em> can be used to create emulated ZBC host managed SCSI disks. The
emulated disk created can be used either locally on the host using the loopback
fabric adapter, as explained <a href="/docs/tools/tcmu-runner#creating-an-emulated-disk">here</a>.</p><p>Similarly to a physical device (previous section), the emulated ZBC disk can
also be attached to a vhost virtual adapter for use within a KVM guest operating
system. The following example illustrates this procedure, creating a small 20GB
host managed SCSI disk with 256 MB zones including 10 conventional zones.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># targetcli</span></div><div class="token-line" style="color:#393A34"><span class="token plain">targetcli shell version 2.1.fb49</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Copyright 2011-2013 by Datera, Inc and others.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">For help on commands, type &#x27;help&#x27;.</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; cd /backstores/user:zbc</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; create name=zbc0 size=20G cfgstring=model-HM/zsize-256/conv-10@/var/local/zbc0.raw</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created user-backed storage object zbc0 size 21474836480.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; cd /vhost</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; create</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created target {==naa.5001405a0776dce3==}.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created TPG 1.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; /vhost/naa.5001405a0776dce3/tpg1/luns create /backstores/user:zbc/zbc0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Created LUN 0.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/vhost&gt; cd /</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; ls</span></div><div class="token-line" style="color:#393A34"><span class="token plain">o- / ..................................................................... [...]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- backstores .......................................................... [...]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- block .............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- fileio ............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- pscsi .............................................. [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- ramdisk ............................................ [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:fbo ........................................... [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:rbd ........................................... [Storage Objects: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  | o- user:zbc ........................................... [Storage Objects: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |   o- zbc0  [model-HM/zsize-256/conv-10@/var/local/zbc0.raw (20.0GiB) activated]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |     o- alua ............................................... [ALUA Groups: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  |       o- default_tg_pt_gp ................... [ALUA state: Active/optimized]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- iscsi ........................................................ [Targets: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- loopback ..................................................... [Targets: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  o- vhost ........................................................ [Targets: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    o- {==naa.5001405a0776dce3==} .......................................... [TPGs: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      o- tpg1 .............................. [naa.500140533e375d94, no-gen-acls]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        o- acls ...................................................... [ACLs: 0]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        o- luns ...................................................... [LUNs: 1]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          o- lun0 ............................... [user/zbc0 (default_tg_pt_gp)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">/&gt; exit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The virtual machine can then be started with the emulated ZBC disk attached
using the World-Wide port name assigned by <em>targetcli</em>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># qemu-kvm (your options) \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device pcie-root-port,bus=pcie.0,id=rp1 \</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    -device vhost-scsi-pci,wwpn={==naa.5001405a0776dce3==},bus=pcie.0</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The disk is listed on the guest with tools such as <em>lsscsi</em>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI plaintext"><div tabindex="0" class="prism-code language-plaintext codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[0:0:0:0]    disk    ATA      QEMU HARDDISK    2.5+  /dev/sda   /dev/sg0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[6:0:1:0]    zbc     LIO-ORG  TCMU ZBC device  0002  /dev/sdb   /dev/sg1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="qemu-nvme-zns-device-emulation"></a><em>QEMU</em> NVMe ZNS Device emulation<a class="hash-link" href="#qemu-nvme-zns-device-emulation" title="Direct link to heading">#</a></h2><p><a href="/docs/getting-started/zns-emulation">This article</a> describes in details, with
examples, how <em>QEMU</em> can be configured to create an emulated NVMe ZNS namespace
visible by the guest operating system.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/tools/tcmu-runner"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« tcmu-runner ZBC Disk Emulation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/tests"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">System Compliance Tests Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#qemu-and-zoned-block-devices" class="table-of-contents__link">QEMU and zoned block devices</a></li><li><a href="#qemu-virtio-scsi" class="table-of-contents__link"><em>QEMU virtio-scsi</em></a></li><li><a href="#qemu-vhost-scsi" class="table-of-contents__link"><em>QEMU vhost-scsi</em></a><ul><li><a href="#enabling-the-host-vhost-target-module" class="table-of-contents__link">Enabling the host vhost target module</a></li><li><a href="#attaching-a-host-physical-disk" class="table-of-contents__link">Attaching a host physical disk</a></li><li><a href="#attaching-an-emulated-zbc-disk" class="table-of-contents__link">Attaching an emulated ZBC disk</a></li></ul></li><li><a href="#qemu-nvme-zns-device-emulation" class="table-of-contents__link"><em>QEMU</em> NVMe ZNS Device emulation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/zoned-storage">Introduction to Zoned Storage</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting Started with Zoned Storage</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://app.element.io/#/room/#zonedstorage-general:matrix.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix</a></li><li class="footer__item"><a href="https://join.slack.com/t/zonedstorage/shared_invite/zt-uyfut5xe-nKajp9YRnEWqiD4X6RkTFw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://webchat.oftc.net/?channels=zonedstorage" target="_blank" rel="noopener noreferrer" class="footer__link-item">IRC @ OFTC</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/westerndigitalcorporation" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Organization</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Western Digital
	Corporation or its affiliates. All rights reserved.<br> By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use" target="_blank">Terms of Use</a> and <a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank">Privacy Statement</a>.  All example scripts and program snippets on this site are licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CCO 1.0 Universal</a> license.<br>This site is built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.97f7f774.js"></script>
<script src="/assets/js/main.e827f9a4.js"></script>
</body>
</html>