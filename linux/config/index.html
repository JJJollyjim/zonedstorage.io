<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Linux Zoned Storage Documentation">
    
    <link rel="canonical" href="https://zonedstorage.io/linux/config/">
    <link rel="shortcut icon" href="../../img/favicon.ico">

    
    <title>Enabling Zoned Block Device Support - Zoned Storage</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D23L5EBB2E"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-D23L5EBB2E');
    </script>
    

     
</head>

<body style="padding-top:90px" >

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="../..">Zoned Storage</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../community/">Community</a>
                    </li>
                
                
                
                    <li class="dropdown active" style="min-height:60;">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../introduction">Introduction</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../introduction/zoned-storage/">Zoned Storage Overview</a>
</li>

        
            
<li >
    <a href="../../introduction/smr/">Shingled Magnetic Recording (SMR) HDDs</a>
</li>

        
            
<li >
    <a href="../../introduction/zns/">Zoned Namespace (ZNS) SSDs</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../getting-started">Getting Started</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../getting-started/prerequisite/">System Prerequisite</a>
</li>

        
            
<li >
    <a href="../../getting-started/nullblk/">Getting Started with an Emulated Zoned Block Device</a>
</li>

        
            
<li >
    <a href="../../getting-started/smr-disk/">Getting Started With SMR Disks</a>
</li>

        
            
<li >
    <a href="../../getting-started/smr-emulation/">Getting Started With Emulated SMR Disks</a>
</li>

        
            
<li >
    <a href="../../getting-started/zns-emulation/">Getting Started With Emulated NVMe ZNS Devices</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu active">
    <a tabindex="-1" href="..">Linux Kernel Support</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../overview/">Support Overview</a>
</li>

        
            
<li class="active">
    <a href="./">Enabling Zoned Block Device Support</a>
</li>

        
            
<li >
    <a href="../zbd-api/">User Interface</a>
</li>

        
            
<li >
    <a href="../sched/">Write Command Ordering</a>
</li>

        
            
<li >
    <a href="../part/">Zoned Block Device Partition Support</a>
</li>

        
            
<li >
    <a href="../dm/">Device Mapper</a>
</li>

        
            
<li >
    <a href="../fs/">File Systems</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../projects">Applications and Libraries</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../projects/util-linux/">Linux System Utilities</a>
</li>

        
            
<li >
    <a href="../../projects/sg3utils/">SCSI Generic Utilities</a>
</li>

        
            
<li >
    <a href="../../projects/libzbc/">libzbc User Library</a>
</li>

        
            
<li >
    <a href="../../projects/libnvme/">libnvme User Library</a>
</li>

        
            
<li >
    <a href="../../projects/libzbd/">libzbd User Library</a>
</li>

        
            
<li >
    <a href="../../projects/tcmu-runner/">tcmu-runner ZBC Disk Emulation</a>
</li>

        
            
<li >
    <a href="../../projects/qemu/">QEMU and KVM</a>
</li>

        
            
<li >
    <a href="../../projects/zns/">Linux Tools for ZNS</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../tests">System Compliance Tests</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../tests/zbc-tests/">ZBC/ZAC Compliance Tests</a>
</li>

        
            
<li >
    <a href="../../tests/blktests/">Kernel Block Layer Tests</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../distributions/linux/">Linux Distributions</a>
</li>

                        
                            
<li >
    <a href="../../benchmarking/fio/">Benchmarking</a>
</li>

                        
                            
<li >
    <a href="../../faq/faq/">Frequently Asked Questions</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../about/">About</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../overview/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../zbd-api/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    
    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
  <h5 style="text-align:center"><b>Table of contents</b></h5>
  <ul class="nav bs-sidenav">

  

    

      

        
        
        
          <li class="first-level"><a href="../../introduction">Introduction</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        
        
        
          <li class="first-level"><a href="../../getting-started">Getting Started</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        
        
        
          <li class="first-level active"><a href="/linux/" style="font-weight:bold">Linux Kernel Support</a></li>
          
        

        

  	  
            <li class="second-level"><a href="../overview/">Support Overview</a></li>
          

  	  

        

  	  

  	  
            
              <li class="second-level active"><a href="#enabling-zoned-block-device-support">Enabling Zoned Block Device Support</a></li>
              
                <li class="third-level"><a href="#kernel-configuration">Kernel Configuration</a></li>
                
                  <li class="fourth-level"><a href="#block-layer">Block Layer</a></li>
                
                  <li class="fourth-level"><a href="#write-ordering-control">Write Ordering Control</a></li>
                
                  <li class="fourth-level"><a href="#device-drivers-configuration">Device Drivers Configuration</a></li>
                
                  <li class="fourth-level"><a href="#device-mapper">Device Mapper</a></li>
                
                  <li class="fourth-level"><a href="#file-systems">File Systems</a></li>
                
              
                <li class="third-level"><a href="#kernel-compilation">Kernel Compilation</a></li>
                
              
                <li class="third-level"><a href="#kernel-installation">Kernel Installation</a></li>
                
              
            
          

        

  	  
            <li class="second-level"><a href="../zbd-api/">User Interface</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../sched/">Write Command Ordering</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../part/">Zoned Block Device Partition Support</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../dm/">Device Mapper</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../fs/">File Systems</a></li>
          

  	  

        

      

    

      

        
        
        
          <li class="first-level"><a href="../../projects">Applications and Libraries</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        
        
        
          <li class="first-level"><a href="../../tests">System Compliance Tests</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        <li class="first-level"><a href="../../distributions/linux/">Linux Distributions</a></li>

      

    

      

        <li class="first-level"><a href="../../benchmarking/fio/">Benchmarking</a></li>

      

    

      

        <li class="first-level"><a href="../../faq/faq/">Frequently Asked Questions</a></li>

      

    

  

  </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="enabling-zoned-block-device-support">Enabling Zoned Block Device Support</h1>
<h2 id="kernel-configuration">Kernel Configuration</h2>
<p>Several kernel compilation configuration options control zoned block device
support features.</p>
<h3 id="block-layer">Block Layer</h3>
<h4 id="zoned-block-devices-core-support">Zoned Block Devices Core Support</h4>
<p>To allow exposing supported zoned block devices as block device files, the block
layer configuration option <code>CONFIG_BLK_DEV_ZONED</code> must be enabled. This option
is part of the <em>Enable the block layer</em> top menu of <code>make menuconfig</code>.</p>
<p><center>
<img alt="config-zbd" src="../../assets/img/linux-config-zbd.png" title="Block layer zoned block device support option with make menuconfig" />
<br><em>Block layer zoned block device support option with <code>make menuconfig</code></em></br>
</center></p>
<p>Without this configuration option set, users will not have access to the ZBD
interface and support for zoned block devices will be disabled in all kernel
subsystems (I/O schedulers, device mapper and file systems) that include support
for these devices.</p>
<h3 id="write-ordering-control">Write Ordering Control</h3>
<p>Write ordering control is achieved through the <em>deadline</em> (legacy single queue
block I/O path) and <em>mq-deadline</em> (multi-queue block I/O path) block I/O
scheduler (see <a href="../sched/">Write Ordering Control</a>). <em>deadline</em> and <em>mq-deadline</em>
zoned block device support is automatically enabled if the
<code>CONFIG_BLK_DEV_ZONED</code> configuration option is set.</p>
<p>Enabling this scheduler is mandatory for zoned block devices. This is
controlled with the <code>CONFIG_MQ_IOSCHED_DEADLINE</code> option for <em>mq-deadline</em> and
with the <code>CONFIG_IOSCHED_DEADLINE</code> option for <em>deadline</em>. Either option can be
selected from the <em>IO Schedulers</em> top menu.</p>
<p><center>
<img alt="config-sched" src="../../assets/img/linux-config-sched.png" title="I/O scheduler configuration with make menuconfig" />
<br><em>I/O scheduler configuration with <code>make menuconfig</code></em></br>
</center></p>
<p>With the introduction of kernel version 5.0 and the removal of the block layer
legacy single queue I/O path, only the <em>mq-deadline</em> scheduler remains. Since
kernel version 5.2, the selection of the <code>CONFIG_MQ_IOSCHED_DEADLINE</code> option is
automatic when the <code>CONFIG_BLK_DEV_ZONED</code> configuration option is set. </p>
<h3 id="device-drivers-configuration">Device Drivers Configuration</h3>
<h4 id="null_blk-logical-device"><em>null_blk</em> Logical Device</h4>
<p>Support for the <a href="/getting-started/nullblk">zoned block device emulation</a> with
the <em>null_blk</em> device driver zoned mode is automatically enabled with the
<code>CONFIG_BLK_DEV_ZONED</code> configuration option.</p>
<h4 id="zbc-and-zac-hard-disks-support">ZBC and ZAC Hard-Disks Support</h4>
<p>The SCSI subsystem support for ZBC and ZAC SMR disks is automatically enabled
with the <code>CONFIG_BLK_DEV_ZONED</code> configuration option.</p>
<h4 id="nvme-zoned-namespace-solid-state-disks-support">NVMe Zoned Namespace Solid State Disks Support</h4>
<p>NVM Express Zoned Namespace Command Set depends on <code>CONFIG_BLK_DEV_ZONED</code> and
<code>CONFIG_NVME_CORE</code> and is automatically built if both configuration options are
enabled.</p>
<p>The driver requires the device to support the Zone Append command to
successfully bind to a zoned namespace, and does not support Zone Excursions.
See <a href="/introduction/zns">Zoned Namespace (ZNS) SSDs</a> for more details about
these features.</p>
<h3 id="device-mapper">Device Mapper</h3>
<p>Zoned block device support for the device mapper subsystem is automatically
enabled when the <code>CONFIG_BLK_DEV_ZONED</code> option is set. This will enables support
for the <em>dm-linear</em> and <em>dm-flakey</em> targets. However, the <em>dm-zoned</em>
device mapper target must be enabled to be usable.</p>
<p>Enabling the <em>dm-zoned</em> target can be done by selecting the <code>CONFIG_DM_ZONED</code>
option from the menu <em>Device Drivers &rarr; Multiple devices driver support (RAID
and LVM) &rarr; Device mapper support &rarr; Drive-managed zoned block device target
support</em>.</p>
<p><center>
<img alt="config-dm" src="../../assets/img/linux-config-dm.png" title="*dm-zoned* device mapper target configuration with make menuconfig" />
<br><em>dm-zoned device mapper target configuration with <code>make menuconfig</code></em></br>
</center></p>
<h3 id="file-systems">File Systems</h3>
<h4 id="f2fs"><em>f2fs</em></h4>
<p>Support for zoned block devices in the <a href="/linux/fs#f2fs"><em>f2fs</em> file system</a>
is automatically enabled with the <code>CONFIG_BLK_DEV_ZONED</code> configuration option.</p>
<h4 id="zonefs"><em>zonefs</em></h4>
<p>Enabling compilation of the <em>zonefs</em> file system is done by selecting the
<code>CONFIG_ZONEFS_FS</code> option from the menu <em>File systems -&gt; zonefs filesystem
support</em>. This option is available only and only if the <code>CONFIG_BLK_DEV_ZONED</code>
option is set to enable zoned block device support.</p>
<p><center>
<img alt="config-zonefs" src="../../assets/img/linux-config-zonefs.png" title="*zonefs* filesystem configuration with make menuconfig" />
<br><em>zonefs filesystem configuration with <code>make menuconfig</code></em></br>
</center></p>
<h2 id="kernel-compilation">Kernel Compilation</h2>
<p>After completing the kernel configuration to enable zoned block device support,
the kernel compilation process does not differ from building a kernel without
zoned block device support. That is, the following commands will build the
kernel.</p>
<pre><code class="language-bash">$ make all
</code></pre>
<p>The kernel build infrastructure also enables build <em>.rpm</em> or <em>i.deb</em> packages.
To build RPM packages, the following command is used.</p>
<pre><code class="language-bash">$ make rpm-pkg
</code></pre>
<h2 id="kernel-installation">Kernel Installation</h2>
<p>Similarly to the compilation process, installing a zoned block device enabled
kernel follows the same procedure as a regular kernel. That is, for a local
installation, the following command can be used.</p>
<pre><code class="language-bash">$ sudo make modules_install install
</code></pre>
<p>This must be followed eventually by the system boot loader configuration as
required (or not) by the distribution used.</p>
<p>The host system can then be restarted to execute the kernel enabling zoned block
device support.</p>
<p>One additional step is however highly recommended: reinstalling the kernel
headers. Doing so, the file <em>/usr/include/linux/blkzoned.h</em> will be installed,
thus allowing applications to be compiled against the
<a href="/linux/zbd-api">zoned block device API</a> supported by the kernel.</p>
<p>Installing the kernel user header files is done using the following command.</p>
<pre><code class="language-bash">$ sudo make headers_install
</code></pre>
<p>See the kernel <code>make help</code> output for more information on this directive.</p>
<p>With the kernel user header files installed, it is recommended to recompile
from source any package that will be used to manage and access zoned
block devices. In particular, recompiling and re-instlalling
<a href="/projects/util-linux">Linux system utilities</a> is highly recommended as many
other packages rely on <em>util-linux</em> zoned block device features (e.g. file
systems formatting tools through <em>libblkid</em>).</p>
<p>The kernel installation and user header files installation can be simplified by
using the RPM packages generated with the <code>make rpm-pkg</code> command. Installing
all the packages generated will install the kernel core itself, the associated
driver modules and the user API herder files. The RPM package 
<code>kernel-headers-&lt;version&gt;.&lt;arch&gt;.rpm</code> must be installed for the kernel user API
header files to be updated.</p></div>
        
        
    </div>
    

    <footer class="col-md-12 text-center">
        
        <span class="text-muted" style="color:hsla(0,0%,100%,.7);font-size:13px;">
	&copy; 2020 Western Digital Corporation or its affiliates. All rights reserved.<br>
        By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use"
	target="_blank" style="color:white;">Terms of Use</a> and
	<a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank" style="color:white;">Privacy Statement</a>.
        All example scripts and program snippets on this site are licensed under
	<a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" style="color:white;">CC0 1.0 Universal</a>.<br>
	Documentation built with <a href="https://www.mkdocs.org/" target="_blank" style="color:white;">MkDocs</a> using a theme
	based on <a href="https://sourcefoundry.org/cinder/" target="_blank" style="color:white;">Cinder</a>.
        </span>
        
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/c.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/bash.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/plaintext.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
</body>

</html>
