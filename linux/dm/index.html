<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Linux Zoned Storage Documentation">
    
    <link rel="canonical" href="https://westerndigitalcorporation.github.io/zonedstorage.io/linux/dm/">
    <link rel="shortcut icon" href="../../img/favicon.ico">

    
    <title>Device Mapper - Zoned Storage</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D23L5EBB2E"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-D23L5EBB2E');
    </script>
    

     
</head>

<body style="padding-top:90px" >

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="../..">1 - Zoned Storage</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">3 - Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../community/">3 - Community</a>
                    </li>
                
                
                
                    <li class="dropdown active" style="min-height:60;">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">2 - Documentation <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../introduction">5 - Introduction</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../introduction/zoned-storage/">4 - Zoned Storage Overview</a>
</li>

        
            
<li >
    <a href="../../introduction/smr/">4 - Shingled Magnetic Recording (SMR) HDDs</a>
</li>

        
            
<li >
    <a href="../../introduction/zns/">4 - Zoned Namespace (ZNS) SSDs</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../getting-started">5 - Getting Started</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../getting-started/prerequisite/">4 - System Prerequisite</a>
</li>

        
            
<li >
    <a href="../../getting-started/nullblk/">4 - Getting Started with an Emulated Zoned Block Device</a>
</li>

        
            
<li >
    <a href="../../getting-started/smr-disk/">4 - Getting Started With SMR Disks</a>
</li>

        
            
<li >
    <a href="../../getting-started/smr-emulation/">4 - Getting Started With Emulated SMR Disks</a>
</li>

        
            
<li >
    <a href="../../getting-started/zns-emulation/">4 - Getting Started With Emulated NVMe ZNS Devices</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu active">
    <a tabindex="-1" href="..">5 - Linux Kernel Support</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../overview/">4 - Support Overview</a>
</li>

        
            
<li >
    <a href="../config/">4 - Kernel Configuration</a>
</li>

        
            
<li >
    <a href="../zbd-api/">4 - User Interface</a>
</li>

        
            
<li >
    <a href="../sched/">4 - Write Command Ordering</a>
</li>

        
            
<li >
    <a href="../part/">4 - Zoned Block Device Partition Support</a>
</li>

        
            
<li class="active">
    <a href="./">4 - Device Mapper</a>
</li>

        
            
<li >
    <a href="../fs/">4 - File Systems</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../projects">5 - Applications and Libraries</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../projects/util-linux/">4 - Linux System Utilities</a>
</li>

        
            
<li >
    <a href="../../projects/sg3utils/">4 - SCSI Generic Utilities</a>
</li>

        
            
<li >
    <a href="../../projects/libzbc/">4 - libzbc User Library</a>
</li>

        
            
<li >
    <a href="../../projects/libnvme/">4 - libnvme User Library</a>
</li>

        
            
<li >
    <a href="../../projects/libzbd/">4 - libzbd User Library</a>
</li>

        
            
<li >
    <a href="../../projects/tcmu-runner/">4 - tcmu-runner ZBC Disk Emulation</a>
</li>

        
            
<li >
    <a href="../../projects/qemu/">4 - QEMU and KVM</a>
</li>

        
            
<li >
    <a href="../../projects/zns/">4 - Linux Tools for ZNS</a>
</li>

        
    </ul>
  </li>

                        
                            
  
  
  
  <li class="dropdown-submenu">
    <a tabindex="-1" href="../../tests">5 - System Compliance Tests</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../tests/zbc-tests/">4 - ZBC/ZAC Compliance Tests</a>
</li>

        
            
<li >
    <a href="../../tests/blktests/">4 - Kernel Block Layer Tests</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../distributions/linux/">4 - Linux Distributions</a>
</li>

                        
                            
<li >
    <a href="../../benchmarking/fio/">4 - Benchmarking</a>
</li>

                        
                            
<li >
    <a href="../../faq/faq/">4 - Frequently Asked Questions</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../about/">3 - About</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../part/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../fs/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    
    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
  <h5 style="text-align:center"><b>Table of contents</b></h5>
  <ul class="nav bs-sidenav">

  

    

      

        
        
        
          <li class="first-level"><a href="../../introduction">Introduction</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        
        
        
          <li class="first-level"><a href="../../getting-started">Getting Started</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        
        
        
          <li class="first-level active"><a href="/linux/" style="font-weight:bold">Linux Kernel Support</a></li>
          
        

        

  	  
            <li class="second-level"><a href="../overview/">Support Overview</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../config/">Kernel Configuration</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../zbd-api/">User Interface</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../sched/">Write Command Ordering</a></li>
          

  	  

        

  	  
            <li class="second-level"><a href="../part/">Zoned Block Device Partition Support</a></li>
          

  	  

        

  	  

  	  
            
              <li class="second-level active"><a href="#device-mapper">Device Mapper</a></li>
              
                <li class="third-level"><a href="#dm-linear">dm-linear</a></li>
                
                  <li class="fourth-level"><a href="#zoned-block-device-restrictions">Zoned Block Device Restrictions</a></li>
                
                  <li class="fourth-level"><a href="#example-creating-a-small-host-managed-disk">Example: Creating a Small Host Managed Disk</a></li>
                
                  <li class="fourth-level"><a href="#example-conventional-zones-as-a-regular-disk">Example: Conventional Zones as a Regular Disk</a></li>
                
              
                <li class="third-level"><a href="#dm-flakey">dm-flakey</a></li>
                
                  <li class="fourth-level"><a href="#error-modes">Error modes</a></li>
                
                  <li class="fourth-level"><a href="#zoned-block-device-restrictions_1">Zoned Block Device Restrictions</a></li>
                
                  <li class="fourth-level"><a href="#examples">Examples</a></li>
                
              
                <li class="third-level"><a href="#dm-zoned">dm-zoned</a></li>
                
                  <li class="fourth-level"><a href="#design-overview">Design Overview</a></li>
                
                  <li class="fourth-level"><a href="#on-disk-format">On-Disk Format</a></li>
                
                  <li class="fourth-level"><a href="#read-write-processing">Read-Write Processing</a></li>
                
                  <li class="fourth-level"><a href="#random-zone-reclaim">Random Zone Reclaim</a></li>
                
                  <li class="fourth-level"><a href="#userspace-tool">Userspace Tool</a></li>
                
                  <li class="fourth-level"><a href="#formatting-a-target-device">Formatting a Target Device</a></li>
                
                  <li class="fourth-level"><a href="#activating-a-target-device">Activating a Target Device</a></li>
                
                  <li class="fourth-level"><a href="#stopping-a-target-device">Stopping a Target Device</a></li>
                
              
            
          

        

  	  
            <li class="second-level"><a href="../fs/">File Systems</a></li>
          

  	  

        

      

    

      

        
        
        
          <li class="first-level"><a href="../../projects">Applications and Libraries</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        
        
        
          <li class="first-level"><a href="../../tests">System Compliance Tests</a></li>
          
        

        

  	  

  	  

        

  	  

  	  

        

      

    

      

        <li class="first-level"><a href="../../distributions/linux/">Linux Distributions</a></li>

      

    

      

        <li class="first-level"><a href="../../benchmarking/fio/">Benchmarking</a></li>

      

    

      

        <li class="first-level"><a href="../../faq/faq/">Frequently Asked Questions</a></li>

      

    

  

  </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="device-mapper">Device Mapper</h1>
<p>Zoned block device support was added to the device mapper subsystem with kernel
version 4.13. Two existing targets gained support: the <em>dm-linear</em> target and
the <em>dm-flakey</em> target. ZBD support also added a new target driver, <em>dm-zoned</em>.</p>
<h2 id="dm-linear">dm-linear</h2>
<p>The <em>dm-linear</em> target maps a linear range of blocks of the device-mapper device
onto a linear range of a backend device. <em>dm-linear</em> is the basic building
block of logical volume managers such as
<a href="http://www.sourceware.org/lvm2/" target="_blank"><em>LVM</em></a>.</p>
<h3 id="zoned-block-device-restrictions">Zoned Block Device Restrictions</h3>
<p>When used with zoned block devices, the <em>dm-linear</em> device created will also be
a zoned block device with the same zone size as the underlying device. Several
conditions are enforced by the device mapper core management code for the
creation of a <em>dm-linear</em> target device.</p>
<ul>
<li>All backend devices used to map different ranges of the target device must
  have the same zone model.</li>
<li>If the backend devices are zoned block devices, all devices must have the same
  zone size.</li>
<li>The mapped ranges must be zone aligned, that is, partial zone mapping is not
  possible.</li>
</ul>
<h3 id="example-creating-a-small-host-managed-disk">Example: Creating a Small Host Managed Disk</h3>
<p>This example illustrates how to create a small host managed disk using zone
ranges from a large high capacity host managed disk. The zone information of
the backend device used is shown below.</p>
<pre><code class="language-plaintext"># cat /sys/block/sdb/queue/zoned
host-managed
# cat /sys/block/sdb/queue/chunk_sectors
524288
# blkzone report /dev/sdb
  start: 0x000000000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000080000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000100000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000180000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  ...
  start: 0x010580000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x010600000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x010680000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x010700000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  ...
  start: 0x6d2300000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x6d2380000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
</code></pre>
<p>To create a <em>dm-linear</em> device named "small-sdb" joining the first 5
conventional zones of the backend device with the first 10 sequential zones, the
following command can be used.</p>
<pre><code class="language-plaintext"># echo &quot;0 2621440 linear /dev/sdb 0
2621440 5242880 linear /dev/sdb 274726912&quot; | dmsetup create small-sdb
</code></pre>
<p>The resulting device zone model is also host managed and has 15 zones as shown
below.</p>
<pre><code class="language-plaintext"># cat /sys/block/dm-0/queue/zoned
host-managed
# cat /sys/block/dm-0/queue/chunk_sectors
524288
# blkzone report /dev/dm-0
  start: 0x000000000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000080000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000100000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000180000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000200000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000280000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000300000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000380000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000400000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000480000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000500000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000580000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000600000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000680000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000700000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
</code></pre>
<p>The following shows a script facilitating the creation of <em>dm-linear</em> devices
using zone ranges from a single zoned block device. Such small zoned block
devices are useful for testing applications limits (e.g. Disk full conditions).</p>
<pre><code class="language-bash">#!/bin/bash

if [ $# != 3 ]; then
    echo &quot;Usage: $0 &lt;disk&gt; &lt;num conv zones&gt; &lt;num seq zones&gt;&quot;
    exit 1
fi

disk=&quot;$1&quot;
nrconv=$2
nrseq=$3
dname=&quot;`basename ${disk}`&quot;

# Linear table entries: &quot;start length linear device offset&quot;
# start: starting block in virtual device
# length: length of this segment
# device: block device, referenced by the device name or by major:minor
# offset: starting offset of the mapping on the device

convlen=$(( $nrconv * 524288 ))
seqlen=$(( $nrseq * 524288 ))

if [ $convlen -eq 0 ] &amp;&amp; [ $seqlen -eq 0 ]; then
    echo &quot;0 zones...&quot;
    exit 1
fi

seqofst=`zbc_report_zones $1 | grep &quot;Sequential-write-required&quot; | head -n1 | cut -f5 -d',' | cut -f3 -d' '`
if [ $convlen -gt $seqofst ]; then
    nrconv=$(( $seqofst / 524288 ))
    echo &quot;Too many conventional zones requested: truncating to $nrconv&quot;
    convlen=$seqofst
fi

if [ $convlen -eq 0 ]; then

echo &quot;0 ${seqlen} linear ${disk} ${seqofst}&quot; | dmsetup create small-${dname}

elif [ $seqlen -eq 0 ]; then

echo &quot;0 ${convlen} linear ${disk} 0&quot; | dmsetup create small-${dname}

else

echo &quot;0 ${convlen} linear ${disk} 0
${convlen} ${seqlen} linear ${disk} ${seqofst}&quot; | dmsetup create small-${dname}

fi
</code></pre>
<h3 id="example-conventional-zones-as-a-regular-disk">Example: Conventional Zones as a Regular Disk</h3>
<p><em>dm-linear</em> can also be used to aggregate a zoned block device conventional
zones together into a target device that will be usable as a regular disk
(conventional zones can be randomly written). Reusing the previous example
backend disk, 524 conventional zones of 524288 sectors (512 B unit) are
available. The following command creates a <em>dm-linear</em> device joining all
conventional zones together.</p>
<pre><code class="language-plaintext"># echo &quot;0 274726912 linear /dev/sdb 0&quot; | dmsetup create small-sdb
</code></pre>
<p>The target device is again a host managed disk but contains only conventional
zones.</p>
<pre><code class="language-plaintext"># cat /sys/block/dm-0/queue/zoned
host-managed
# cat /sys/block/dm-0/queue/chunk_sectors
524288
# blkzone report /dev/dm-0
  start: 0x000000000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000080000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000100000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000180000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  ...
  start: 0x010500000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x010580000, len 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
</code></pre>
<p>This zoned block device being composed of only conventional zones, all sectors
are randomly writable and can thus be used directly with any file system.</p>
<pre><code class="language-plaintext"># mkfs.ext4 /dev/dm-0
mke2fs 1.44.6 (5-Mar-2019)
Creating filesystem with 34340864 4k blocks and 8585216 inodes
Filesystem UUID: 3957429a-5dab-4b30-9797-f9736036a47b
Superblock backups stored on blocks:
    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
    4096000, 7962624, 11239424, 20480000, 23887872

Allocating group tables: done
Writing inode tables: done
Creating journal (262144 blocks): done
Writing superblocks and filesystem accounting information: done

# mount /dev/dm-0 /mnt
# ls -l /mnt
total 16
drwx------ 2 root root 16384 May 21 17:03 lost+found
</code></pre>
<p>Applications needing frequent random updates to their metadata can use such
setup to facilitate implementation of a complex metadata structure. The
remaining sequential zones of the disk can be used directly by the application
to store data.</p>
<h2 id="dm-flakey">dm-flakey</h2>
<p>The <em>dm-flakey</em> target is similar to the <em>dm-linear</em> target except that it
exhibits unreliable behavior periodically. This target is useful in simulating
failing devices for testing purposes. In the case of zoned block devices,
simulating write errors to sequential zones can help in debugging application
write pointer management.</p>
<p>Starting from the time the table is loaded, the device does not generate errors
for some seconds (<em>up</em> time), then exhibits unreliable behavior for <em>down</em>
seconds. This cycle then repeats.</p>
<h3 id="error-modes">Error modes</h3>
<p>Several error simulation behavior can be configured.</p>
<ul>
<li><strong>drop_writes</strong> All write I/Os are silently ignored and dropped. Read I/Os
  are handled correctly.</li>
<li><strong>error_writes</strong> All write I/Os are failed with an error signaled. Read I/Os
  are handled correctly.</li>
<li><strong>corrupt_bio_byte</strong> During the <em>down</em> time, replace the Nth byte of the
  data of each read or write block I/O with a specified value.</li>
</ul>
<p>The default error mode is to fail all I/O requests during the <em>down</em> time of the
simulation cycle.</p>
<h3 id="zoned-block-device-restrictions_1">Zoned Block Device Restrictions</h3>
<p>The same restrictions as for the <em>dm-linear</em> target apply.</p>
<h3 id="examples">Examples</h3>
<p><em>dm-linear</em> detailed documentation and usage examples can be found in the kernel
source code documentation file
<a href="https://github.com/torvalds/linux/blob/master/Documentation/device-mapper/dm-flakey.txt" target="_blank">
 Documentation/device-mapper/dm-flakey.txt</a>.</p>
<h2 id="dm-zoned">dm-zoned</h2>
<p>The <em>dm-zoned</em> device mapper target provides random write access to zoned
block devices (ZBC and ZAC compliant devices). It hides to the device user
(a file system or an application doing raw block device accesses) the
sequential write constraint of host-managed zoned block devices, allowing the
use of applications and file systems that do not have native zoned block
device support.</p>
<p>File systems or applications that can natively support host-managed zoned
block devices (e.g. the f2fs file system since kernel 4.10) do not need to use
the <em>dm-zoned</em> device mapper target.</p>
<h3 id="design-overview">Design Overview</h3>
<p><em>dm-zoned</em> implements an on-disk write buffering scheme to handle random
write accesses to sequential write required zones of a zoned block device.
Conventional zones of the backend device are used for buffering random
accesses, as well as for storing internal metadata.</p>
<p>The figure below illustrates <em>dm-zoned</em> zone usage principle.</p>
<p><center>
<img alt="dm-zoned" src="../../assets/img/linux-dm-zoned.png" title="*Zone mapping overview of the *dm-zoned* device mapper target" />
<br><em>Zone mapping overview of the dm-zoned device mapper target</em></br>
</center></p>
<p>Optionally, since Linux kernel version 5.8.0, an additional regular block
device can also be used to provide randomly writable storage used in place of
the conventional zones of the backend zoned block device for write buffering.
With this new version of <em>dm-zoned</em>, multiple zoned block devices can also be
used to increase performance.</p>
<p>All zones of the device(s) used to back a <em>dm-zoned</em> target are separated into
2 types:</p>
<ol>
<li>
<p><strong>Metadata zones</strong> These are randomly writable zones used to store metadata.
   Randomly writable zones may be conventional zones or sequential write
   preferred zones (host-aware devices only). Metadata zones are not reported
   as usable capacity to the user. If an additional regular block device is used
   for write buffering, metadata zones are stored on this cache device.</p>
</li>
<li>
<p><strong>Data zones</strong> All remaining zones of the device. The majority of these zones
   will be sequential zones which are used used exclusively for storing user
   data. The conventional zones (or part of the sequential write preferred zones
   on a host-aware device) may be used also for buffering user random writes.
   User data may thus be stored either in conventional zone or in a sequential
   zone.</p>
</li>
</ol>
<p>As shown in the above figure, the target device is divided into chunks that
have the same size as the zones of the backing zoned devices. A logical chunk
can be mapped to zones of the backing device in different ways.</p>
<ol>
<li><strong>Conventional or cache zone mapping</strong> This is the case for chunk <em>A</em> in the
   figure which is mapped to the conventional zone <em>C<sub>A</sub></em>. This is the
   default mapping initialized when the first write command is issued to an
   empty (unwritten) chunk. As long as a chunk is mapped to a conventional zone,
   any incoming write request can be directly executed using the mapped
   conventional zone.</li>
<li><strong>Sequential zone mapping</strong> A chunk initially can also be mapped to a
   sequential zone as shown for the chunk <em>C</em> mapped to the sequential zone
   <em>S<sub>C</sub></em> in the figure. With such mapping, a already written block of
   the chunk cannot be modified directly. To handle this case, the next mapping
   type is used.</li>
<li><strong>Dual conventional-sequential zone mapping</strong> To process data updates to
   written blocks of a chunk mapped to a sequential zone, a conventional zone
   may be temporarily added to the chunk mapping. Any write targeting a written
   block will be processed using the conventional zone rather than the
   sequential zone.</li>
</ol>
<p><em>dm-zoned</em> metadata include a set of bitmaps to track the validity state of
blocks in the backing device zones. Any write operation execution is always
followed by an update to the bitmaps to mark the written blocks as valid. In the
case of the dual conventional-sequential chunk mapping, the bitmap for the
blocks of the sequential zone is also updated to clear the bits representing the
blocks updated but written to the conventional zone. Doing so, incoming reads
always gain access to the latest version of the block data by simply inspecting
the block validity bitmaps.</p>
<h3 id="on-disk-format">On-Disk Format</h3>
<p><em>dm-zoned</em> exposes a logical device with a sector size of 4096 bytes,
irrespectively of the physical sector size of the backend zoned block device
being used. This allows reducing the amount of metadata needed to manage valid
blocks (blocks written). The on-disk metadata format is as follows:</p>
<ol>
<li>
<p>The first block of the first randomly writable zone found contains the
super block which describes the amount and position on disk of metadata blocks. </p>
</li>
<li>
<p>Following the super block, a set of blocks is used to describe the mapping
of the logical chunks of the target logical device to data zones. The mapping
is indexed by logical chunk number and each mapping entry indicates the data
zone storing the chunk data and optionally the zone number of a random zone
used to buffer random modification to the chunk data.</p>
</li>
<li>
<p>A set of blocks used to store bitmaps indicating the validity of blocks in
the data zones follows the mapping table blocks. A valid block is a block that
was writen and not discarded. For a buffered data zone, a block can be valid
only in the data zone or in the buffer zone.</p>
</li>
</ol>
<p>To protect internal metadata against corruption in case of sudden power loss or
system crash, two sets of metadata zones are used. One set, the primary set, is
used as the main metadata set, while the secondary set is used as a log.
Modified metadata are first written to the secondary set and the log so created
validated by writing an updated super block in the secondary set. Once this log
operation completes, updates in place of metadata blocks can be done in the
primary metadata set, ensuring that one of the set is always correct.
Flush operations are used as a commit point: upon reception of a flush
operation, metadata activity is temporarily stopped, all dirty metadata logged
and updated and normal operation resumed. This only temporarily delays write and
discard requests. Read requests can be processed while metadata logging is
executed.</p>
<h3 id="read-write-processing">Read-Write Processing</h3>
<p>For a logical chunk mapped to a random data zone, all write operations are
processed by directly writing to the data zone. If the mapping zone is to a
sequential zone, the write operation is processed directly only and only if
the write offset within the logical chunk is equal to the write pointer offset
within of the sequential data zone (i.e. the write operation is aligned on the
zone write pointer). Otherwise, write operations are processed indirectly using 
a buffer zone: a randomly writable free data zone is allocated and assigned
to the chunk being accessed in addition to the already mapped sequential data
zone. Writing block to the buffer zone will invalidate the same blocks in the
sequential data zone.</p>
<p>Read operations are processed according to the block validity information
provided by the bitmaps: valid blocks are read either from the data zone or,
if the data zone is buffered, from the buffer zone assigned to the data zone.</p>
<h3 id="random-zone-reclaim">Random Zone Reclaim</h3>
<p>After some time, the limited number of random zones available may be exhausted
and unaligned writes to unbuffered zones become impossible. To avoid such
situation, a reclaim process regularly scans used random zones and try to
"reclaim" them by copying (sequentially) the valid blocks of the buffer zone
to a free sequential zone. Once the copy completes, the chunk mapping is
updated to point to the sequential zone and the buffer zone freed for reuse.</p>
<p>To protect internal metadata against corruption in case of sudden power loss or
system crash, 2 sets of metadata zones are used. One set, the primary set, is
used as the main metadata repository, while the secondary set is used as a log.
Modified metadata are first written to the secondary set and the log so created
validated by writing an updated super block in the secondary set. Once this log
operation completes, updates in place of metadata blocks can be done in the
primary metadata set, ensuring that one of the set is always correct.
Flush operations are used as a commit point: upon reception of a flush
operation, metadata activity is temporarily stopped, all dirty metadata logged
and updated and normal operation resumed. This only temporarily delays write
and discard requests. Read requests can be processed while metadata logging is
executed.</p>
<h3 id="userspace-tool">Userspace Tool</h3>
<p>The <em>dmzadm</em> command line utility is used to format backend zoned devices for
use with the <em>dm-zoned</em> device mapper target. This utility will verify the
device zone model and will prepare and write on-disk <em>dm-zoned</em> metadata
according to the device capacity, zone size, etc.</p>
<p>The source code for the <em>dmzadm</em> utility is available as part of the
<a href="https://github.com/westerndigitalcorporation/dm-zoned-tools"
target="_blank"><em>dm-zoned-tools</em> project hosted on GitHub</a>.
The project
<a href="https://github.com/westerndigitalcorporation/dm-zoned-tools/blob/master/README.md"
target="_blank"><em>README</em> file</a> provides instructions on how to compile and
install the utility.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <em>dm-zoned-tools</em> project was formerly hosted on GitHub as part of
the <a href="https://github.com/hgst" target="_blank">HGST organization</a>.
<em>dm-zoned-tools</em> repository has since then moved to the
<a href="https://github.com/westerndigitalcorporation/"
target="_blank">Western Digital Corporation organization on GitHub</a>.</p>
</div>
<p><em>dmzadm</em> detailed usage is as follows.</p>
<pre><code class="language-plaintext"># dmzadm --help
dmzadm allows formatting, checking and repairing
a zoned block device for use with the dm-zoned
device mapper.
Usage: dmzadm &lt;operation&gt; &lt;device(s)&gt; [options]
Operations
  --help | -h   : General help message
  --format      : Format a block device metadata
  --check       : Check a block device metadata
  --repair      : Repair a block device metadata
  --start       : Start the device-mapper target
  --stop        : Stop the device-mapper target
Devices
  For a single device target, a zoned block device
  must be specified. For a multi-device target, a
  a list of block devices must be specified, with
  a regular block device as the first device specified,
  followed by one or more zoned block devices
General options
  --verbose     : Verbose output
  --vverbose    : Very verbose output
Format operation options
  --force       : Force overwrite of existing content
  --label=&lt;str&gt; : Set the target label name to &lt;str&gt;
  --seq=&lt;num&gt;   : Number of sequential zones reserved
                  for reclaim. The minimum is 1 and the
                  default is 16
</code></pre>
<h3 id="formatting-a-target-device">Formatting a Target Device</h3>
<p>Formatting a single device target is done using the command.</p>
<pre><code class="language-plaintext"># dmzadm --format /dev/&lt;disk name&gt;
</code></pre>
<p>where <code>/dev/&lt;disk name&gt;</code> identifies the backend zoned block device to use. An
example execution using a SMR hard-disk is shown below.</p>
<pre><code class="language-plaintext"># dmzadm --format /dev/sdi
/dev/sdi: 29297213440 512-byte sectors (13970 GiB)
  Host-managed device
  55880 zones, offset 0
  55880 zones of 524288 512-byte sectors (256 MiB)
  65536 4KB data blocks per zone
Resetting sequential zones
Writing primary metadata set
  Writing mapping table
  Writing bitmap blocks
  Writing super block to sdi block 0
Writing secondary metadata set
  Writing mapping table
  Writing bitmap blocks
  Writing super block to sdi block 131072
Syncing disk
Done.
</code></pre>
<p>Starting with Linux kernel v5.8.0, regular block devices such as SSDs can also
be used together with zoned block devices with <em>dm-zoned</em>. In this case,
conventional zones are emulated for the regular block device to hold <em>dm-zoned</em>
metadata and for buffering data. When a regular block device is used, the zone
reclaim process operates by copying data from emulated conventional zones on
the regular block device to zones of the zoned block device. This dual-drive
configuration can significantly increase performance of the target device
under write-intensive workloads.</p>
<p>To format a <em>dm-zoned</em> target device using an additional regular block device
and optionally several zoned block devices, the following commands can be used.</p>
<pre><code class="language-plaintext"># dmzadm --format /dev/nvme2n1 /dev/sdi
/dev/nvme2n1: 976773168 512-byte sectors (465 GiB)
  Regular block device
  1864 zones, offset 0
/dev/sdi: 29297213440 512-byte sectors (13970 GiB)
  Host-managed device
  55880 zones, offset 122159104
  57743 zones of 524288 512-byte sectors (256 MiB)
  1 runt zone of 24624 512-byte sectors (12 MiB)
  65536 4KB data blocks per zone
Resetting sequential zones
Writing primary metadata set
  Writing mapping table
  Writing bitmap blocks
  Writing super block to nvme2n1 block 0
Writing secondary metadata set
  Writing mapping table
  Writing bitmap blocks
  Writing super block to nvme2n1 block 131072
Writing tertiary metadata
  Writing super block to sdi block 0
Syncing disk
Syncing disk
Done.
</code></pre>
<p>Where <code>/dev/nvme2n1</code> is in this example a NVMe SSD and <code>/dev/sdi</code> is a
host managed SMR hard-disk.</p>
<h3 id="activating-a-target-device">Activating a Target Device</h3>
<p>The <em>dm-zoned</em> target device using a formatted zoned device or set of devices
can be started by executing <em>dmzadm</em> with the <code>--start</code> command.</p>
<pre><code class="language-plaintext"># dmzadm --start /dev/sdi
/dev/sdi: 29297213440 512-byte sectors (13970 GiB)
  Host-managed device
  55880 zones, offset 0
  55880 zones of 524288 512-byte sectors (256 MiB)
  65536 4KB data blocks per zone
sdi: starting dmz-sdi uuid 8c505b4b-d1e9-47a7-8e3a-8b1c00317eaf
</code></pre>
<p>The target start can be confirmed by looking at the kernel messages.</p>
<pre><code class="language-plaintext"># dmesg
...
device-mapper: zoned metadata: (dmz-sdi): DM-Zoned metadata version 2
device-mapper: zoned metadata: (sdi): Host-managed zoned block device
device-mapper: zoned metadata: (sdi):   29297213440 512-byte logical sectors (offset 0)
device-mapper: zoned metadata: (sdi):   55880 zones of 524288 512-byte logical sectors (offset 0)
device-mapper: zoned metadata: (dmz-sdi):   55880 zones of 524288 512-byte logical sectors
device-mapper: zoned: (dmz-sdi): Target device: 29286727680 512-byte logical sectors (3660840960 blocks)
</code></pre>
<p>The target device created is a regular disk that can be used with any file
system.</p>
<pre><code class="language-plaintext"># cat /sys/block/dm-0/queue/zoned
none
# mkfs.ext4 /dev/dm-0
mke2fs 1.45.5 (07-Jan-2020)
Discarding device blocks: done                            
Creating filesystem with 3660840960 4k blocks and 457605120 inodes
Filesystem UUID: d49ed278-5bca-46c4-8ce2-cec263dd060c
Superblock backups stored on blocks: 
    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
    4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968, 
    102400000, 214990848, 512000000, 550731776, 644972544, 1934917632, 
    2560000000

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (262144 blocks): done
Writing superblocks and filesystem accounting information: done

# mount /dev/dm-0 /mnt
# ls -l /mnt
total 16
drwx------ 2 root root 16384 Aug 27 15:14 lost+found
</code></pre>
<p>For a multi-device target, the same list of devices as used for format must be
specified.</p>
<pre><code class="language-plaintext"># dmzadm --start /dev/nvmen2p1 /dev/sdi
/dev/nvme2n1: 976773168 512-byte sectors (465 GiB)
  Regular block device
  1864 zones, offset 0
/dev/sdi: 29297213440 512-byte sectors (13970 GiB)
  Host-managed device
  55880 zones, offset 122159104
  57743 zones of 524288 512-byte sectors (256 MiB)
  1 runt zone of 24624 512-byte sectors (12 MiB)
  65536 4KB data blocks per zone
nvme2n1: starting dmz-nvme2n1 uuid ffbd1a3a-d79b-4d7f-bc13-e475a157bc39
</code></pre>
<p>Similarly to the single device case, kernel messages notify the target device
activation.</p>
<pre><code class="language-plaintext">device-mapper: zoned metadata: (dmz-nvme2n1): DM-Zoned metadata version 2
device-mapper: zoned metadata: (nvme2n1): Regular block device
device-mapper: zoned metadata: (nvme2n1):   976773168 512-byte logical sectors (offset 0)
device-mapper: zoned metadata: (nvme2n1):   1864 zones of 524288 512-byte logical sectors (offset 0)
device-mapper: zoned metadata: (sdi): Host-managed zoned block device
device-mapper: zoned metadata: (sdi):   29297213440 512-byte logical sectors (offset 977272832)
device-mapper: zoned metadata: (sdi):   55880 zones of 524288 512-byte logical sectors (offset 1864)
device-mapper: zoned metadata: (dmz-nvme2n1):   57744 zones of 524288 512-byte logical sectors
device-mapper: zoned: (dmz-nvme2n1): Target device: 30264000512 512-byte logical sectors (3783000064 blocks)
</code></pre>
<h3 id="stopping-a-target-device">Stopping a Target Device</h3>
<p>A <em>dm-zoned</em> target device can be disabled using the <code>--stop</code> operation.</p>
<pre><code class="language-plaintext"># dmzadm --stop /dev/sdX
</code></pre>
<p>For a multi-device target, the same list of devices as used for format must be
specified.</p></div>
        
        
    </div>
    

    <footer class="col-md-12 text-center">
        
        <span class="text-muted" style="color:hsla(0,0%,100%,.7);font-size:13px;">
	&copy; 2020 Western Digital Corporation or its affiliates. All rights reserved.<br>
        By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use"
	target="_blank" style="color:white;">Terms of Use</a> and
	<a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank" style="color:white;">Privacy Statement</a>.
        All example scripts and program snippets on this site are licensed under
	<a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" style="color:white;">CC0 1.0 Universal</a>.<br>
	Documentation built with <a href="https://www.mkdocs.org/" target="_blank" style="color:white;">MkDocs</a> using a theme
	based on <a href="https://sourcefoundry.org/cinder/" target="_blank" style="color:white;">Cinder</a>.
        </span>
        
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/c.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/bash.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/plaintext.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
</body>

</html>
